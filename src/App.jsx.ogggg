import React, { useState, useEffect } from 'react';
import { 
  Users, LayoutDashboard, Wallet, PieChart, Link as LinkIcon, Settings, 
  Search, Filter, Download, ChevronDown, ChevronRight, AlertCircle, Copy, TrendingUp, 
  TrendingDown, DollarSign, Activity, Menu, X, Globe, Map, ArrowLeft, 
  Calculator, Info, Image, FileText, CreditCard, Clock, Plus, Upload, File, Calendar, Bell, Shield, Lock,
  Network, UserCog, Briefcase
} from 'lucide-react';

// PDF Generation Libraries
import jsPDF from 'jspdf';
import autoTable from 'jspdf-autotable';

// Import API functions
import { 
  loginAndGetToken, 
  connectWebSocket, 
  fetchNommiaClients,
  subscribeToTradeUpdates,
  fetchClientTrades,
  submitWithdrawalRequest
} from './api_integration';

import Login from './Login';

// --- Configuration ---
const COMMISSION_RATES = {
  tier1: { fx: 4.50, metals: 8.00 },
  tier2: { fx: 1.00, metals: 3.00 },
  tier3: { fx: 1.00, metals: 2.00 }
};

const PERFORMANCE_BONUS_TIERS = [
  { threshold: 4500, rate: 0.10, label: "Tier 3 (+10%)" },
  { threshold: 1000, rate: 0.08, label: "Tier 2 (+8%)" },
  { threshold: 450, rate: 0.04, label: "Tier 1 (+4%)" },
  { threshold: 0, rate: 0.00, label: "Base Tier (0%)" }
];

// --- Mock Data ---
const MOCK_CLIENTS = [
  { id: 1, name: "Alex Thompson", email: "alex.t@example.com", phone: "+44 7700 900077", kycStatus: "Approved", deposit: 5000, equity: 5240.50, lots: 12.5, lastActive: "2 hrs ago", status: "Active", risk: "Low", ibId: 101, country: "UK" },
  { id: 2, name: "Sarah Jenkins", email: "s.jenkins@test.co", phone: "+44 7700 900123", kycStatus: "Pending", deposit: 0, equity: 0, lots: 0, lastActive: "Never", status: "Onboarding", risk: "N/A", ibId: 101, country: "UK" },
  { id: 3, name: "Michael Chen", email: "m.chen88@nommia.net", phone: "+65 9123 4567", kycStatus: "Approved", deposit: 10000, equity: 2100.00, lots: 45.2, lastActive: "5 mins ago", status: "Active", risk: "High", ibId: 102, country: "Singapore" },
];

const MOCK_NETWORK_TREE = [
  { 
    id: 201, name: "James Wilson", type: "Sub-IB", country: "UK", totalClients: 45, volume: 320.5, revenue: 1450.00, status: "Active",
    subPartners: [
      { id: 301, name: "Bright Futures Ltd", type: "Sub-IB", country: "UK", totalClients: 12, volume: 85.0, revenue: 340.00, status: "Active", subPartners: [] },
      { id: 302, name: "London FX Group", type: "Sub-IB", country: "UK", totalClients: 8, volume: 42.5, revenue: 120.00, status: "Pending", subPartners: [] }
    ]
  },
  { 
    id: 202, name: "Asia Trading Hub", type: "Country Manager", country: "Singapore", totalClients: 150, volume: 1240.0, revenue: 5600.00, status: "Active",
    subPartners: [
      { 
        id: 305, name: "Kuala Lumpur Signals", type: "Sub-IB", country: "Malaysia", totalClients: 40, volume: 310.0, revenue: 980.00, status: "Active", 
        subPartners: [
           { id: 401, name: "Penang FX", type: "Sub-IB", country: "Malaysia", totalClients: 5, volume: 20.0, revenue: 60.00, status: "Active", subPartners: [] }
        ]
      }
    ]
  },
];
// --- Added for Admin Panel ---
const MOCK_ALL_USERS = [
    { id: 1, name: "James Wilson", email: "james@example.com", role: "IB", region: "UK", qualified: true },
    { id: 2, name: "Asia Trading Hub", email: "contact@ath.sg", role: "Country Manager", region: "Singapore", qualified: true },
    { id: 3, name: "New User 123", email: "new@user.com", role: "IB", region: "Germany", qualified: false },
    { id: 4, name: "Sarah Connor", email: "sarah@nommia.net", role: "Regional Manager", region: "EMEA", qualified: true },
];
const INITIAL_CAMPAIGNS = [
  { id: 1, name: "Q4 Crypto Push", tag: "q4-crypto", clicks: 1240, signups: 85, ftd: 42, commission: 2100 },
  { id: 2, name: "Forex Webinar Link", tag: "fx-webinar", clicks: 450, signups: 120, ftd: 95, commission: 4500 },
  { id: 3, name: "General Bio Link", tag: "bio-link", clicks: 3200, signups: 15, ftd: 2, commission: 150 },
];

const INITIAL_ASSETS = [
  { id: 1, name: "Nommia Brand Kit 2024", type: "zip", size: "24 MB", date: "2024-01-15" },
  { id: 2, name: "Social Media Banners (Instagram)", type: "image", size: "5 MB", date: "2024-02-01" },
  { id: 3, name: "Email Marketing Templates", type: "doc", size: "1.2 MB", date: "2024-02-10" },
];

const MOCK_WITHDRAWALS = [
  { id: 101, date: "2024-10-15", amount: 4500.00, method: "Bank Wire", status: "Paid" },
  { id: 102, date: "2024-09-12", amount: 1200.00, method: "USDT", status: "Paid" },
  { id: 103, date: "2024-11-01", amount: 5000.00, method: "Bank Wire", status: "Processing" },
];

const MOCK_SYSTEM_ALERTS = [
  { id: 1, title: "Withdrawal Rejected", msg: "Bank wire to ending in 8829 failed. Please check details.", type: "critical", time: "10 mins ago" },
  { id: 2, title: "KYC Update Required", msg: "Proof of Address rejected. Document unclear.", type: "warning", time: "2 hrs ago" },
  { id: 3, title: "Deposit Confirmed", msg: "Incoming transfer of $5,000.00 successfully cleared.", type: "success", time: "5 hrs ago" },
];

// --- Helper Components ---

const SidebarItem = ({ icon: Icon, label, active, onClick, collapsed }) => (
  <button 
    onClick={onClick}
    className={`w-full flex items-center p-3 mb-1 transition-all rounded-lg ${
      active 
        ? 'bg-amber-500 text-neutral-900 font-bold shadow-lg shadow-amber-500/20' 
        : 'text-neutral-400 hover:bg-neutral-800 hover:text-white'
    }`}
  >
    <Icon size={20} className="min-w-[20px]" />
    {!collapsed && <span className="ml-3 font-medium whitespace-nowrap">{label}</span>}
  </button>
);

const StatCard = ({ title, value, subtext, trend, icon: Icon, trendUp }) => (
  <div className="bg-neutral-900 rounded-xl p-6 shadow-sm border border-neutral-800 flex items-start justify-between">
    <div>
      <p className="text-sm font-medium text-neutral-400 mb-1">{title}</p>
      <h3 className="text-2xl font-bold text-white">{value}</h3>
      <div className="flex items-center mt-2">
        <span className={`text-xs font-semibold px-2 py-0.5 rounded-full flex items-center ${trendUp ? 'bg-emerald-500/10 text-emerald-400 border border-emerald-500/20' : 'bg-red-500/10 text-red-400 border border-red-500/20'}`}>
          {trendUp ? <TrendingUp size={12} className="mr-1"/> : <TrendingDown size={12} className="mr-1"/>}
          {trend}
        </span>
        <span className="text-xs text-neutral-500 ml-2">{subtext}</span>
      </div>
    </div>
    <div className="p-3 bg-neutral-800 rounded-lg text-amber-500 border border-neutral-700 shadow-inner">
      <Icon size={24} />
    </div>
  </div>
);

const StatusBadge = ({ status }) => {
  const styles = {
    Approved: "bg-emerald-500/10 text-emerald-400 border-emerald-500/20",
    Pending: "bg-amber-500/10 text-amber-400 border-amber-500/20",
    Rejected: "bg-red-500/10 text-red-400 border-red-500/20",
    Active: "bg-emerald-500/10 text-emerald-400 border-emerald-500/20",
    Onboarding: "bg-amber-500/10 text-amber-400 border-amber-500/20",
    Paid: "bg-emerald-500/10 text-emerald-400 border-emerald-500/20",
    Processing: "bg-amber-500/10 text-amber-400 border-amber-500/20",
    High: "text-red-400 font-bold",
    Low: "text-emerald-400",
    Medium: "text-amber-400",
    "N/A": "text-neutral-500"
  };
  return (
    <span className={`px-2.5 py-0.5 rounded-full text-xs font-medium border ${styles[status] || "bg-neutral-800 text-neutral-400"}`}>
      {status}
    </span>
  );
};

// --- NEW FEATURES ---

const RealTimeTicker = () => {
  const [latestTrade, setLatestTrade] = useState(null);

  useEffect(() => {
    subscribeToTradeUpdates((data) => {
      setLatestTrade(data);
      setTimeout(() => setLatestTrade(null), 4000);
    });
  }, []);

  if (!latestTrade) return null;

  return (
    <div className="fixed top-20 right-8 z-50 animate-bounce">
      <div className="bg-neutral-900 border border-amber-500/50 shadow-lg shadow-amber-500/20 text-white px-4 py-2 rounded-lg flex items-center space-x-3">
        <div className="bg-emerald-500/20 text-emerald-400 p-1 rounded-full">
          <DollarSign size={16} />
        </div>
        <div>
          <p className="text-xs text-neutral-400 uppercase font-bold">New Commission</p>
          <p className="text-sm font-bold text-amber-500">
            +${latestTrade.amount.toFixed(2)} 
            <span className="text-neutral-500 font-normal ml-1">({latestTrade.symbol})</span>
          </p>
        </div>
      </div>
    </div>
  );
};

const WithdrawalModal = ({ onClose, onSubmit, available }) => {
  const [amount, setAmount] = useState('');
  const [method, setMethod] = useState('Bank Wire');

  return (
    <div className="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4 animate-fadeIn">
      <div className="bg-neutral-900 border border-neutral-700 rounded-xl p-6 w-full max-w-md shadow-2xl relative">
        <button onClick={onClose} className="absolute top-4 right-4 text-neutral-500 hover:text-white"><X size={20}/></button>
        <h3 className="text-xl font-bold text-white mb-1">Request Withdrawal</h3>
        <p className="text-sm text-neutral-400 mb-6">Available Balance: <span className="text-emerald-400 font-bold">${available.toLocaleString()}</span></p>

        <div className="space-y-4">
            <div>
                <label className="text-xs uppercase text-neutral-500 font-bold">Amount</label>
                <div className="relative mt-1">
                    <DollarSign size={16} className="absolute left-3 top-3 text-neutral-500"/>
                    <input 
                        type="number" 
                        value={amount} 
                        onChange={e => setAmount(e.target.value)}
                        className="w-full bg-neutral-950 border border-neutral-700 rounded-lg py-2.5 pl-9 pr-4 text-white focus:border-amber-500 focus:outline-none"
                        placeholder="0.00"
                        max={available}
                    />
                </div>
            </div>
            <div>
                <label className="text-xs uppercase text-neutral-500 font-bold">Method</label>
                <select 
                    value={method} 
                    onChange={e => setMethod(e.target.value)}
                    className="w-full mt-1 bg-neutral-950 border border-neutral-700 rounded-lg py-2.5 px-3 text-white focus:border-amber-500 focus:outline-none"
                >
                    <option>Bank Wire</option>
                    <option>USDT (TRC20)</option>
                    <option>USDT (ERC20)</option>
                    <option>USDC (POL)</option>
                    <option>USDC (ERC20)</option>
                    <option>Skrill</option>
                </select>
            </div>
        </div>

        <div className="mt-8 flex gap-3">
            <button onClick={onClose} className="flex-1 py-2.5 bg-neutral-800 hover:bg-neutral-700 text-white rounded-lg font-medium transition-colors">Cancel</button>
            <button 
                onClick={() => onSubmit(amount, method)}
                disabled={!amount || amount > available}
                className="flex-1 py-2.5 bg-amber-500 hover:bg-amber-400 disabled:opacity-50 disabled:cursor-not-allowed text-neutral-900 rounded-lg font-bold transition-colors"
            >
                Confirm Request
            </button>
        </div>
      </div>
    </div>
  );
};

const CreateCampaignModal = ({ onClose, onSubmit }) => {
  const [name, setName] = useState('');
  
  const handleSubmit = () => {
    if(!name) return;
    const tag = name.toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '');
    onSubmit({ name, tag });
  };

  return (
    <div className="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4 animate-fadeIn">
      <div className="bg-neutral-900 border border-neutral-700 rounded-xl p-6 w-full max-w-sm shadow-2xl relative">
        <button onClick={onClose} className="absolute top-4 right-4 text-neutral-500 hover:text-white"><X size={20}/></button>
        <h3 className="text-xl font-bold text-white mb-4">Create New Campaign</h3>
        
        <div className="space-y-4">
            <div>
                <label className="text-xs uppercase text-neutral-500 font-bold">Campaign Name</label>
                <input 
                    type="text" 
                    value={name} 
                    onChange={e => setName(e.target.value)}
                    className="w-full mt-1 bg-neutral-950 border border-neutral-700 rounded-lg py-2.5 px-4 text-white focus:border-amber-500 focus:outline-none"
                    placeholder="e.g. Summer Promo 2024"
                    autoFocus
                />
            </div>
        </div>
        <div className="mt-6">
            <button 
                onClick={handleSubmit}
                disabled={!name}
                className="w-full py-2.5 bg-amber-500 hover:bg-amber-400 disabled:opacity-50 disabled:cursor-not-allowed text-neutral-900 rounded-lg font-bold transition-colors"
            >
                Create Tracking Link
            </button>
        </div>
      </div>
    </div>
  );
};

const UploadAssetModal = ({ onClose, onSubmit }) => {
  const [name, setName] = useState('');
  const [type, setType] = useState('image');

  const handleSubmit = () => {
    if(!name) return;
    onSubmit({ name, type });
  };

  return (
    <div className="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4 animate-fadeIn">
      <div className="bg-neutral-900 border border-neutral-700 rounded-xl p-6 w-full max-w-sm shadow-2xl relative">
        <button onClick={onClose} className="absolute top-4 right-4 text-neutral-500 hover:text-white"><X size={20}/></button>
        <h3 className="text-xl font-bold text-white mb-4">Upload Marketing Asset</h3>
        
        <div className="space-y-4">
            <div>
                <label className="text-xs uppercase text-neutral-500 font-bold">Asset Name</label>
                <input 
                    type="text" 
                    value={name} 
                    onChange={e => setName(e.target.value)}
                    className="w-full mt-1 bg-neutral-950 border border-neutral-700 rounded-lg py-2.5 px-4 text-white focus:border-amber-500 focus:outline-none"
                    placeholder="e.g. Q4 Banner Set"
                />
            </div>
            <div>
                <label className="text-xs uppercase text-neutral-500 font-bold">File Type</label>
                <select 
                    value={type} 
                    onChange={e => setType(e.target.value)}
                    className="w-full mt-1 bg-neutral-950 border border-neutral-700 rounded-lg py-2.5 px-4 text-white focus:border-amber-500 focus:outline-none"
                >
                    <option value="image">Image (JPG/PNG)</option>
                    <option value="zip">Archive (ZIP)</option>
                    <option value="doc">Document (PDF)</option>
                </select>
            </div>
            <div className="border-2 border-dashed border-neutral-700 rounded-lg p-8 text-center hover:border-amber-500/50 transition-colors cursor-pointer">
                <Upload size={24} className="mx-auto text-neutral-500 mb-2"/>
                <p className="text-xs text-neutral-400">Click to select file</p>
            </div>
        </div>
        <div className="mt-6">
            <button 
                onClick={handleSubmit}
                disabled={!name}
                className="w-full py-2.5 bg-amber-500 hover:bg-amber-400 disabled:opacity-50 disabled:cursor-not-allowed text-neutral-900 rounded-lg font-bold transition-colors"
            >
                Upload Asset
            </button>
        </div>
      </div>
    </div>
  );
};

const ClientDetailView = ({ client, onBack }) => {
  const [history, setHistory] = useState([]);

  useEffect(() => {
    fetchClientTrades(client.id).then(data => setHistory(data));
  }, [client]);

  return (
    <div className="space-y-6 animate-fadeIn">
      <button onClick={onBack} className="flex items-center text-neutral-400 hover:text-white mb-4">
        <ArrowLeft size={18} className="mr-2" /> Back to Client List
      </button>
      
      <div className="bg-neutral-900 border border-neutral-800 p-6 rounded-xl">
        <div className="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 border-b border-neutral-800 pb-6">
            <div>
                <h2 className="text-2xl font-bold text-white">{client.name}</h2>
                <p className="text-neutral-500 text-sm mt-1">Client ID: {client.id} • Account Status: <span className="text-emerald-400 font-medium">{client.status}</span></p>
            </div>
            <div className="mt-4 md:mt-0 text-right">
                 <span className="text-xs text-neutral-500 uppercase font-bold block mb-1">Risk Profile</span>
                 <StatusBadge status={client.risk || 'Low'} />
            </div>
        </div>

        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8">
            <div>
                <p className="text-xs text-neutral-500 uppercase font-bold mb-3 flex items-center"><Users size={12} className="mr-1"/> Contact Info</p>
                <div className="space-y-1">
                  <p className="text-white text-sm font-medium">{client.email}</p>
                  <p className="text-neutral-400 text-sm">{client.phone}</p>
                </div>
            </div>
            <div>
                <p className="text-xs text-neutral-500 uppercase font-bold mb-3 flex items-center"><Globe size={12} className="mr-1"/> Compliance</p>
                <div className="space-y-2">
                  <p className="text-white text-sm flex items-center">{client.country}</p>
                  <StatusBadge status={client.kycStatus} />
                </div>
            </div>
            <div>
                <p className="text-xs text-neutral-500 uppercase font-bold mb-3 flex items-center"><Wallet size={12} className="mr-1"/> Financials</p>
                <div className="space-y-2">
                    <div className="flex justify-between text-sm">
                        <span className="text-neutral-400">Net Deposit:</span>
                        <span className="text-white font-medium">${client.deposit.toLocaleString()}</span>
                    </div>
                    <div className="flex justify-between text-sm">
                        <span className="text-neutral-400">Live Equity:</span>
                        <span className={`font-bold ${client.equity < client.deposit * 0.5 ? 'text-red-400' : 'text-emerald-400'}`}>${client.equity.toLocaleString()}</span>
                    </div>
                </div>
            </div>
            <div>
                <p className="text-xs text-neutral-500 uppercase font-bold mb-3 flex items-center"><Activity size={12} className="mr-1"/> Activity</p>
                <div className="space-y-2">
                    <div className="flex justify-between text-sm">
                        <span className="text-neutral-400">Total Lots:</span>
                        <span className="text-amber-500 font-bold">{client.lots}</span>
                    </div>
                    <div className="flex justify-between text-sm">
                        <span className="text-neutral-400">Last Active:</span>
                        <span className="text-neutral-300">{client.lastActive || 'N/A'}</span>
                    </div>
                </div>
            </div>
        </div>
      </div>

      <div className="bg-neutral-900 border border-neutral-800 rounded-xl overflow-hidden">
        <div className="p-4 border-b border-neutral-800 font-bold text-white bg-neutral-800/20">Trading History</div>
        <div className="overflow-x-auto">
          <table className="w-full text-left text-sm">
              <thead className="bg-neutral-800/50 text-neutral-400 font-semibold">
                  <tr>
                      <th className="p-3">Symbol</th>
                      <th className="p-3">Type</th>
                      <th className="p-3 text-right">Volume</th>
                      <th className="p-3">Open Time</th>
                      <th className="p-3 text-right">P/L</th>
                      <th className="p-3 text-right">Commission</th>
                  </tr>
              </thead>
              <tbody className="divide-y divide-neutral-800">
                  {history.length > 0 ? history.map((trade) => (
                      <tr key={trade.id} className="hover:bg-neutral-800/30">
                          <td className="p-3 font-medium text-white">{trade.symbol}</td>
                          <td className={`p-3 ${trade.type === 'Buy' ? 'text-emerald-400' : 'text-red-400'}`}>{trade.type}</td>
                          <td className="p-3 text-right">{trade.volume}</td>
                          <td className="p-3 text-neutral-500">{trade.openTime}</td>
                          <td className={`p-3 text-right font-medium ${trade.profit >= 0 ? 'text-emerald-400' : 'text-red-400'}`}>
                              {trade.profit >= 0 ? '+' : ''}{trade.profit}
                          </td>
                          <td className="p-3 text-right font-bold text-amber-500">+${trade.commission.toFixed(2)}</td>
                      </tr>
                  )) : (
                    <tr>
                      <td colSpan="6" className="p-8 text-center text-neutral-500">No trading history available.</td>
                    </tr>
                  )}
              </tbody>
          </table>
        </div>
      </div>
    </div>
  );
};

// --- VIEWS ---

const DashboardView = ({ clients, apiStatus, onNavigate }) => {
  const [timeRange, setTimeRange] = useState('Last 7 Days');
  const [showNotifModal, setShowNotifModal] = useState(false);
  const [linkCopied, setLinkCopied] = useState(false);
  const [notifPage, setNotifPage] = useState(1);

  // Mock Metrics Data for different periods
  const metrics = {
    'Last 7 Days': { revenue: 1250.00, deposits: 5000, volume: 145.2, revTrend: '+5.2%', depTrend: '+2.1%', volTrend: '+1.5%' },
    'This Month': { revenue: 4250.50, deposits: 15200, volume: 845.2, revTrend: '+12.5%', depTrend: '+8.4%', volTrend: '-2.4%' },
    'Last Quarter': { revenue: 11500.00, deposits: 45000, volume: 2100.5, revTrend: '+8.1%', depTrend: '+15.3%', volTrend: '+5.7%' },
    'Year to Date': { revenue: 28400.50, deposits: 85000, volume: 5400.2, revTrend: '+18.5%', depTrend: '+22.1%', volTrend: '+12.4%' },
    'Lifetime': { revenue: 45250.00, deposits: 120000, volume: 12500.0, revTrend: '+12.5%', depTrend: '+8.4%', volTrend: '+10.2%' },
  };

  const currentMetrics = metrics[timeRange] || metrics['Lifetime'];
  const activeClients = clients.filter(c => c.status === 'Active').length; // Active clients is a current state
  const pendingKYC = clients.filter(c => c.kycStatus === 'Pending').length;

  const allNotifications = Array.from({ length: 25 }, (_, i) => ({
    id: i,
    type: ['signup', 'deposit', 'kyc', 'trade'][i % 4],
    msg: [
      'New registration from UK', 
      `Client ID #${100+i} deposited $${(Math.random()*1000).toFixed(0)}`, 
      'KYC documents awaiting review', 
      'High volume trade execution'
    ][i % 4],
    time: `${i * 15 + 2} mins ago`,
    icon: [Users, Wallet, FileText, Activity][i % 4],
    color: ['text-blue-400', 'text-emerald-400', 'text-amber-400', 'text-purple-400'][i % 4]
  }));

  const itemsPerPage = 10;
  const totalPages = Math.ceil(allNotifications.length / itemsPerPage);
  const currentNotifications = allNotifications.slice((notifPage - 1) * itemsPerPage, notifPage * itemsPerPage);

  const handleCopyLink = () => {
    navigator.clipboard.writeText("https://nommia.com/register?ib=88321");
    setLinkCopied(true);
    setTimeout(() => setLinkCopied(false), 2000);
  };

  return (
    <div className="space-y-6 animate-fadeIn relative">
      
      {showNotifModal && (
        <div className="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4">
          <div className="bg-neutral-900 border border-neutral-700 rounded-xl w-full max-w-lg shadow-2xl flex flex-col max-h-[80vh]">
            <div className="p-4 border-b border-neutral-800 flex justify-between items-center">
              <h3 className="font-bold text-white">All Notifications</h3>
              <button onClick={() => setShowNotifModal(false)} className="text-neutral-500 hover:text-white"><X size={20}/></button>
            </div>
            <div className="overflow-y-auto p-4 space-y-3 flex-1">
              {currentNotifications.map((notif) => (
                <div key={notif.id} className="flex items-start p-3 bg-neutral-950 rounded-lg border border-neutral-800">
                  <div className={`mt-0.5 min-w-[24px] h-6 rounded-full bg-neutral-900 border border-neutral-700 flex items-center justify-center ${notif.color}`}>
                    <notif.icon size={12} />
                  </div>
                  <div className="ml-3">
                    <p className="text-sm text-neutral-300">{notif.msg}</p>
                    <p className="text-xs text-neutral-600 mt-1 flex items-center"><Clock size={10} className="mr-1"/> {notif.time}</p>
                  </div>
                </div>
              ))}
            </div>
            <div className="p-4 border-t border-neutral-800 flex justify-between items-center bg-neutral-900 rounded-b-xl">
              <button onClick={() => setNotifPage(p => Math.max(1, p - 1))} disabled={notifPage === 1} className="text-xs font-bold text-neutral-400 hover:text-white disabled:opacity-30 disabled:cursor-not-allowed flex items-center px-3 py-2 bg-neutral-800 rounded"><ChevronDown size={14} className="rotate-90 mr-1"/> Previous</button>
              <span className="text-xs text-neutral-500">Page {notifPage} of {totalPages}</span>
              <button onClick={() => setNotifPage(p => Math.min(totalPages, p + 1))} disabled={notifPage === totalPages} className="text-xs font-bold text-neutral-400 hover:text-white disabled:opacity-30 disabled:cursor-not-allowed flex items-center px-3 py-2 bg-neutral-800 rounded">Next <ChevronDown size={14} className="rotate-[-90] ml-1"/></button>
            </div>
          </div>
        </div>
      )}

      {/* Header and Time Filter */}
      <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
        {/* Status Bar */}
        <div className="flex-1 flex gap-4 w-full">
            {apiStatus === 'disconnected' ? (
            <div className="flex-1 bg-amber-900/30 border border-amber-500/30 text-amber-200 p-3 rounded-lg flex items-center text-sm">
                <AlertCircle size={16} className="mr-2" />
                <span>Viewing cached data. Connect to XValley API for live updates.</span>
            </div>
            ) : (
            <div className="flex-1 bg-emerald-900/20 border border-emerald-500/20 text-emerald-300 p-3 rounded-lg flex items-center text-sm">
                <Activity size={16} className="mr-2" />
                <span>Live Stream Active: Receiving tick data...</span>
            </div>
            )}
            
            {pendingKYC > 0 && (
            <div className="bg-neutral-800 border-l-4 border-amber-500 p-3 rounded-r-lg flex items-center shadow-lg animate-pulse hover:animate-none transition-all hidden md:flex">
                <div className="mr-4">
                <div className="text-2xl font-bold text-white">{pendingKYC}</div>
                </div>
                <div>
                <div className="text-xs text-neutral-400 uppercase font-bold">Pending Approvals</div>
                <div className="text-sm text-white">Clients awaiting KYC review</div>
                </div>
                <button onClick={() => onNavigate('clients')} className="ml-4 px-3 py-1 bg-neutral-700 hover:bg-neutral-600 text-xs rounded text-white transition-colors border border-neutral-600">Review Now</button>
            </div>
            )}
        </div>

        {/* Time Selector */}
        <div className="relative min-w-[160px]">
            <select 
                value={timeRange}
                onChange={(e) => setTimeRange(e.target.value)}
                className="w-full bg-neutral-900 border border-neutral-700 text-white text-sm rounded-lg pl-4 pr-10 py-2.5 focus:border-amber-500 outline-none appearance-none font-medium cursor-pointer hover:bg-neutral-800 transition-colors"
            >
                {Object.keys(metrics).map(period => (
                    <option key={period} value={period}>{period}</option>
                ))}
            </select>
            <ChevronDown size={16} className="absolute right-3 top-1/2 -translate-y-1/2 text-neutral-500 pointer-events-none"/>
        </div>
      </div>

      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        <StatCard title="Total Revenue" value={`$${currentMetrics.revenue.toLocaleString()}`} subtext={timeRange} trend={currentMetrics.revTrend} trendUp={!currentMetrics.revTrend.includes('-')} icon={DollarSign} />
        <StatCard title="Active Clients" value={activeClients} subtext="Live accounts (Current)" trend="+5.2%" trendUp={true} icon={Users} />
        <StatCard title="Total Deposits" value={`$${currentMetrics.deposits.toLocaleString()}`} subtext={timeRange} trend={currentMetrics.depTrend} trendUp={!currentMetrics.depTrend.includes('-')} icon={Wallet} />
        <StatCard title="Network Volume" value={`${currentMetrics.volume.toLocaleString()}`} subtext={`${timeRange} (Lots)`} trend={currentMetrics.volTrend} trendUp={!currentMetrics.volTrend.includes('-')} icon={Activity} />
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div className="lg:col-span-2 bg-neutral-900 rounded-xl shadow-sm border border-neutral-800 p-6 flex flex-col">
          <div className="flex justify-between items-center mb-6">
             <div>
               <h3 className="font-bold text-white">Trading Volume History</h3>
               <p className="text-xs text-neutral-500 mt-0.5">Total lots traded by your direct clients</p>
             </div>
             {/* This could also be wired to timeRange if we had chart data for all periods */}
             <div className="text-xs text-neutral-500 font-mono bg-neutral-950 px-2 py-1 rounded border border-neutral-800">
                Viewing: {timeRange}
             </div>
          </div>
          
          <div className="flex-1 flex items-end justify-between space-x-2 h-64 px-2 border-l border-b border-neutral-800 relative">
            <div className="absolute -left-8 top-0 bottom-0 flex flex-col justify-between text-[10px] text-neutral-600 font-mono py-2">
                <span>1000</span><span>500</span><span>0</span>
            </div>
            {[35, 45, 30, 60, 75, 50, 65, 80, 55, 70, 90, 85].map((h, i) => (
              <div key={i} className="w-full relative group">
                <div className="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 hidden group-hover:block bg-neutral-800 text-xs text-white p-2 rounded border border-neutral-700 whitespace-nowrap z-10 shadow-xl">
                   Vol: {h * 10} Lots
                </div>
                <div className="w-full bg-neutral-800/50 rounded-t-sm h-full relative overflow-hidden">
                   <div className="absolute bottom-0 w-full bg-gradient-to-t from-amber-600 to-amber-400 rounded-t-sm transition-all duration-500 group-hover:bg-amber-500 shadow-[0_0_10px_rgba(245,158,11,0.3)]" style={{ height: `${h}%` }}></div>
                </div>
                <div className="text-[10px] text-neutral-600 text-center mt-2">{i + 1}</div>
              </div>
            ))}
          </div>
          <div className="text-center text-xs text-neutral-500 mt-2 font-mono uppercase tracking-widest">Time Period Interval</div>
        </div>

        <div className="space-y-6">
          <div className="bg-gradient-to-br from-neutral-800 to-neutral-900 p-6 rounded-xl border border-neutral-700 shadow-lg">
             <h4 className="text-white font-bold mb-2 flex items-center"><LinkIcon size={16} className="mr-2 text-amber-500"/> Quick Invite</h4>
             <p className="text-xs text-neutral-400 mb-3">Copy your default referral link to start earning.</p>
             <div className="flex bg-neutral-950 rounded border border-neutral-700 p-1 relative">
                <input readOnly value="https://nommia.com/register?ib=88321" className="bg-transparent text-xs text-neutral-300 px-2 w-full focus:outline-none"/>
                <button 
                  onClick={handleCopyLink}
                  className={`px-3 py-1.5 rounded text-xs font-bold transition-colors min-w-[60px] ${linkCopied ? 'bg-emerald-500 text-white' : 'bg-neutral-800 hover:bg-neutral-700 text-white'}`}
                >
                  {linkCopied ? "Copied!" : "Copy"}
                </button>
             </div>
          </div>

          <div className="bg-neutral-900 rounded-xl shadow-sm border border-neutral-800 p-6 flex-1 flex flex-col">
            <h3 className="font-bold text-white mb-4 text-sm uppercase tracking-wider flex items-center justify-between">
              Live Activity
              <span className="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></span>
            </h3>
            <div className="space-y-5 flex-1 overflow-hidden">
              {currentNotifications.slice(0, 4).map((act) => (
                <div key={act.id} className="flex items-start">
                  <div className={`mt-0.5 min-w-[24px] h-6 rounded-full bg-neutral-900 border border-neutral-700 flex items-center justify-center ${act.color}`}>
                    <act.icon size={12} />
                  </div>
                  <div className="ml-3">
                    <p className="text-sm text-neutral-300 leading-snug">{act.msg}</p>
                    <p className="text-xs text-neutral-600 mt-0.5 flex items-center"><Clock size={10} className="mr-1"/> {act.time}</p>
                  </div>
                </div>
              ))}
            </div>
            <button onClick={() => setShowNotifModal(true)} className="w-full mt-6 py-2 text-xs text-neutral-500 hover:text-white border border-neutral-800 rounded hover:bg-neutral-800 transition-colors">
              View All Notifications
            </button>
          </div>
        </div>
      </div>
    </div>
  );
};

const ClientsView = ({ clients }) => {
  const [selectedClient, setSelectedClient] = useState(null);
  const [searchTerm, setSearchTerm] = useState('');

  if (selectedClient) {
    return <ClientDetailView client={selectedClient} onBack={() => setSelectedClient(null)} />;
  }

  const filteredClients = clients.filter(client => 
    client.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
    client.email.toLowerCase().includes(searchTerm.toLowerCase())
  );

  const handleExport = () => {
    const headers = ["ID,Name,Email,Phone,Country,KYC Status,Net Deposit,Equity,Lots Traded,Risk Level,Status"];
    const rows = filteredClients.map(c => 
      `${c.id},"${c.name}",${c.email},${c.phone},"${c.country}",${c.kycStatus},${c.deposit},${c.equity},${c.lots},${c.risk},${c.status}`
    );
    const csvContent = "data:text/csv;charset=utf-8," + [headers, ...rows].join("\n");
    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", "nommia_client_list.csv");
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  };

  return (
    <div className="bg-neutral-900 rounded-xl shadow-sm border border-neutral-800 flex flex-col h-full animate-fadeIn">
      <div className="p-5 border-b border-neutral-800 flex flex-col sm:flex-row sm:items-center justify-between gap-4 bg-neutral-900 rounded-t-xl">
        <div>
          <h2 className="text-lg font-bold text-white">Client Management</h2>
          <p className="text-sm text-neutral-400">View KYC status, deposits, and trading activity.</p>
        </div>
        <div className="flex gap-2">
          <div className="relative">
            <Search size={18} className="absolute left-3 top-1/2 transform -translate-y-1/2 text-neutral-500" />
            <input type="text" placeholder="Search clients..." className="pl-10 pr-4 py-2 border border-neutral-700 bg-neutral-800 text-neutral-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-amber-500 w-full sm:w-64 placeholder-neutral-500" value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} />
          </div>
          <button 
            onClick={handleExport}
            className="flex items-center px-4 py-2 bg-amber-500 text-neutral-900 rounded-lg text-sm font-bold hover:bg-amber-400 transition-colors shadow-lg shadow-amber-500/20"
          >
            <Download size={18} className="mr-2" /> Export
          </button>
        </div>
      </div>
      <div className="overflow-x-auto flex-1 bg-neutral-900 rounded-b-xl">
        <table className="w-full text-left border-collapse">
          <thead>
            <tr className="bg-neutral-800/50 text-neutral-400 text-xs uppercase font-semibold tracking-wider border-b border-neutral-800">
              <th className="p-4">Name / Contact</th><th className="p-4">Country</th><th className="p-4">KYC Status</th><th className="p-4 text-right">Net Deposit</th><th className="p-4 text-right">Equity (Live)</th><th className="p-4 text-right">Lots Traded</th><th className="p-4">Risk Level</th><th className="p-4 text-center">Actions</th>
            </tr>
          </thead>
          <tbody className="divide-y divide-neutral-800">
            {filteredClients.length > 0 ? (
              filteredClients.map((client) => (
                <tr key={client.id} onClick={() => setSelectedClient(client)} className="hover:bg-neutral-800/50 transition-colors group cursor-pointer">
                  <td className="p-4"><div className="font-medium text-neutral-200 group-hover:text-amber-500">{client.name}</div><div className="text-xs text-neutral-400 flex flex-col"><span>{client.email}</span><span>{client.phone}</span></div></td>
                  <td className="p-4 text-sm text-neutral-500">{client.country}</td>
                  <td className="p-4"><StatusBadge status={client.kycStatus} /></td>
                  <td className="p-4 text-right font-medium text-neutral-300">${(client.deposit || 0).toLocaleString()}</td>
                  <td className="p-4 text-right"><span className={`font-bold ${client.equity < client.deposit * 0.5 && client.deposit > 0 ? 'text-red-400' : 'text-neutral-200'}`}>${(client.equity || 0).toLocaleString(undefined, { minimumFractionDigits: 2 })}</span></td>
                  <td className="p-4 text-right font-medium text-amber-500">{client.lots || 0}</td>
                  <td className="p-4"><StatusBadge status={client.risk || 'Low'} /></td>
                  <td className="p-4 text-center"><button className="text-neutral-500 hover:text-amber-500 transition-colors p-1"><Settings size={16} /></button></td>
                </tr>
              ))
            ) : (
              <tr>
                <td colSpan="8" className="p-8 text-center text-neutral-500 italic">No clients found matching "{searchTerm}"</td>
              </tr>
            )}
          </tbody>
        </table>
      </div>
    </div>
  );
};

// C. UPDATED MARKETING VIEW (With Assets & Admin Mode)
const MarketingView = ({ userRole }) => {
  const [subTab, setSubTab] = useState('links');
  const [campaigns, setCampaigns] = useState(INITIAL_CAMPAIGNS);
  const [assets, setAssets] = useState(INITIAL_ASSETS);
  const [showModal, setShowModal] = useState(false);
  const [showUploadModal, setShowUploadModal] = useState(false);
  const [copiedId, setCopiedId] = useState(null);

  const handleAddCampaign = (newCampaign) => {
    const id = campaigns.length + 1;
    const campaignObj = {
      id,
      name: newCampaign.name,
      tag: newCampaign.tag,
      clicks: 0,
      signups: 0,
      ftd: 0,
      commission: 0
    };
    setCampaigns([...campaigns, campaignObj]);
    setShowModal(false);
  };

  const handleAddAsset = (newAsset) => {
    const id = assets.length + 1;
    const assetObj = {
        id,
        name: newAsset.name,
        type: newAsset.type,
        size: "1.5 MB", // Mock size
        date: new Date().toISOString().split('T')[0]
    };
    setAssets([...assets, assetObj]);
    setShowUploadModal(false);
  };

  const copyCampaignLink = (tag, id) => {
    const link = `https://nommia.com/register?ib=88321&c=${tag}`;
    navigator.clipboard.writeText(link);
    setCopiedId(id);
    setTimeout(() => setCopiedId(null), 2000);
  };

  return (
    <div className="space-y-6 animate-fadeIn relative">
      {/* Create Modals */}
      {showModal && <CreateCampaignModal onClose={() => setShowModal(false)} onSubmit={handleAddCampaign} />}
      {showUploadModal && <UploadAssetModal onClose={() => setShowUploadModal(false)} onSubmit={handleAddAsset} />}

      <div className="flex space-x-1 bg-neutral-900 p-1 rounded-lg w-fit border border-neutral-800">
        <button onClick={() => setSubTab('links')} className={`px-4 py-2 text-sm font-medium rounded-md transition-all ${subTab === 'links' ? 'bg-amber-500 text-neutral-900 font-bold shadow' : 'text-neutral-500 hover:text-neutral-300'}`}>Referral Links</button>
        <button onClick={() => setSubTab('assets')} className={`px-4 py-2 text-sm font-medium rounded-md transition-all ${subTab === 'assets' ? 'bg-amber-500 text-neutral-900 font-bold shadow' : 'text-neutral-500 hover:text-neutral-300'}`}>Marketing Assets</button>
      </div>

      {subTab === 'links' ? (
        <>
          <div className="bg-gradient-to-br from-neutral-800 to-black rounded-xl p-8 text-white shadow-lg shadow-black/50 relative overflow-hidden border border-neutral-700">
            <div className="relative z-10">
              <h2 className="text-2xl font-bold mb-2">Your Unique Referral Link</h2>
              <p className="text-neutral-300 mb-6 max-w-lg">Share this link to track your clients automatically.</p>
              <div className="flex bg-neutral-900/50 backdrop-blur-md rounded-lg p-1.5 max-w-xl border border-neutral-600">
                <input type="text" readOnly value="https://nommia.com/register?ib=88321" className="flex-1 bg-transparent border-none text-white px-3 focus:outline-none font-mono text-sm" />
                <button 
                    onClick={() => {
                        navigator.clipboard.writeText("https://nommia.com/register?ib=88321");
                        alert("Main link copied!");
                    }}
                    className="bg-amber-500 hover:bg-amber-400 text-neutral-900 px-4 py-2 rounded-md font-bold text-sm transition-colors flex items-center shadow-lg"
                >
                    <Copy size={16} className="mr-2" /> Copy
                </button>
              </div>
            </div>
            <div className="absolute right-0 bottom-0 opacity-5 text-white"><LinkIcon size={200} /></div>
          </div>
          
          <div className="bg-neutral-900 rounded-xl shadow-sm border border-neutral-800 p-6">
            <div className="flex justify-between items-center mb-6">
                <h3 className="font-bold text-white text-lg">Campaign Performance</h3>
                <button 
                    onClick={() => setShowModal(true)}
                    className="flex items-center bg-neutral-800 hover:bg-neutral-700 text-white px-3 py-2 rounded-lg text-sm border border-neutral-700 transition-colors"
                >
                    <Plus size={16} className="mr-2 text-amber-500"/> New Campaign
                </button>
            </div>
            
            <div className="overflow-x-auto">
              <table className="w-full text-left">
                <thead>
                    <tr className="border-b border-neutral-800 text-xs font-semibold text-neutral-500 uppercase tracking-wider">
                        <th className="pb-3 pl-2">Campaign Name</th>
                        <th className="pb-3">Tracking Tag</th>
                        <th className="pb-3 text-right">Clicks</th>
                        <th className="pb-3 text-right">Sign Ups</th>
                        <th className="pb-3 text-right">FTD</th>
                        <th className="pb-3 text-right">Conversion</th>
                        <th className="pb-3 text-right">Commission</th>
                        <th className="pb-3 text-center">Link</th>
                    </tr>
                </thead>
                <tbody className="divide-y divide-neutral-800">
                  {campaigns.map(camp => (
                    <tr key={camp.id} className="text-sm hover:bg-neutral-800/30 transition-colors">
                      <td className="py-4 pl-2 font-medium text-neutral-200">{camp.name}</td>
                      <td className="py-4 text-neutral-500 font-mono text-xs">{camp.tag}</td>
                      <td className="py-4 text-right text-neutral-400">{camp.clicks.toLocaleString()}</td>
                      <td className="py-4 text-right text-neutral-400">{camp.signups}</td>
                      <td className="py-4 text-right font-bold text-neutral-200">{camp.ftd}</td>
                      <td className="py-4 text-right">
                        <span className="bg-emerald-500/10 text-emerald-400 border border-emerald-500/20 px-2 py-1 rounded-full text-xs">
                           {camp.clicks > 0 ? ((camp.ftd / camp.clicks) * 100).toFixed(2) : "0.00"}%
                        </span>
                      </td>
                      <td className="py-4 text-right font-bold text-amber-500">+${camp.commission.toLocaleString()}</td>
                      <td className="py-4 text-center">
                        <button 
                            onClick={() => copyCampaignLink(camp.tag, camp.id)}
                            className="text-neutral-500 hover:text-amber-500 transition-colors"
                            title="Copy Campaign Link"
                        >
                            {copiedId === camp.id ? <span className="text-emerald-500 text-xs font-bold">Copied</span> : <Copy size={16} />}
                        </button>
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </div>
        </>
      ) : (
        // ASSETS VIEW
        <div className="space-y-6">
            {/* Header / Admin Actions */}
            <div className="flex justify-between items-center bg-neutral-900 p-4 rounded-xl border border-neutral-800">
                <div>
                    <h3 className="font-bold text-white">Downloadable Assets</h3>
                    <p className="text-xs text-neutral-400">Materials to help you promote.</p>
                </div>
                {userRole === 'Admin' && (
                    <button 
                        onClick={() => setShowUploadModal(true)}
                        className="flex items-center px-4 py-2 bg-amber-500 hover:bg-amber-400 text-neutral-900 rounded-lg text-sm font-bold transition-colors"
                    >
                        <Upload size={16} className="mr-2"/> Upload Asset
                    </button>
                )}
            </div>

            {/* Asset Grid */}
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            {assets.map((asset) => (
                <div key={asset.id} className="bg-neutral-900 p-4 rounded-xl border border-neutral-800 group hover:border-amber-500/50 transition-all">
                    <div className="h-32 bg-neutral-950 rounded-lg flex items-center justify-center mb-4 border border-neutral-800 relative overflow-hidden">
                        {asset.type === 'image' ? <Image size={48} className="text-neutral-700 group-hover:text-amber-500 transition-colors" /> : 
                         asset.type === 'zip' ? <File size={48} className="text-neutral-700 group-hover:text-amber-500 transition-colors" /> :
                         <FileText size={48} className="text-neutral-700 group-hover:text-amber-500 transition-colors" />}
                    </div>
                    <div className="flex justify-between items-start">
                        <div>
                            <h4 className="font-bold text-white text-sm">{asset.name}</h4>
                            <p className="text-xs text-neutral-500 mt-1">{asset.type.toUpperCase()} • {asset.size}</p>
                        </div>
                    </div>
                    <button className="w-full py-2 border border-neutral-700 hover:bg-neutral-800 text-amber-500 rounded-lg text-sm font-medium mt-4 flex items-center justify-center transition-colors">
                        <Download size={14} className="mr-2"/> Download
                    </button>
                </div>
            ))}
            </div>
        </div>
      )}
    </div>
  );
};

// --- NEW REPORTS VIEW ---
const ReportsView = () => {
  const [dateRange, setDateRange] = useState('This Month');

  const handleDownloadStatement = () => {
    // 1. Initialize PDF
    const doc = new jsPDF();

    // 2. Add Title & Metadata
    doc.setFontSize(20);
    doc.setTextColor(245, 158, 11); // Amber color
    doc.text("Nommia Partner Statement", 14, 22);
    
    doc.setFontSize(10);
    doc.setTextColor(100);
    doc.text(`Generated on: ${new Date().toLocaleDateString()}`, 14, 30);
    doc.text(`Period: ${dateRange}`, 14, 35);

    // 3. Define Table Data
    const tableColumn = ["Date", "Type", "Details", "Amount", "Balance"];
    const tableRows = [
      ['2024-03-01', 'Opening Balance', 'Brought Forward', '$4,500.00', '$4,500.00'],
      ['2024-03-05', 'Commission', 'Trade #88291 (Gold)', '+$150.00', '$4,650.00'],
      ['2024-03-10', 'Withdrawal', 'Bank Wire Transfer', '-$2,000.00', '$2,650.00'],
      ['2024-03-12', 'Bonus', 'Tier 2 Performance Bonus', '+$500.00', '$3,150.00'],
      ['2024-03-15', 'Commission', 'Weekly Aggregated Volume', '+$1,250.50', '$4,400.50'],
    ];

    // 4. Generate Table
    autoTable(doc, {
      head: [tableColumn],
      body: tableRows,
      startY: 45,
      theme: 'grid',
      headStyles: { fillColor: [23, 23, 23], textColor: [255, 255, 255] }, // Dark header
      styles: { fontSize: 9 },
    });

    // 5. Save PDF
    doc.save(`Nommia_Statement_${new Date().toISOString().split('T')[0]}.pdf`);
  };

  return (
    <div className="space-y-6 animate-fadeIn">
      {/* 1. Reports Header & Filters */}
      <div className="flex flex-col md:flex-row justify-between items-start md:items-center bg-neutral-900 p-6 rounded-xl border border-neutral-800">
        <div>
          <h2 className="text-xl font-bold text-white flex items-center"><PieChart size={20} className="mr-2 text-amber-500"/> Performance Reports</h2>
          <p className="text-sm text-neutral-400 mt-1">Deep dive analytics into your referral business.</p>
        </div>
        <div className="mt-4 md:mt-0 flex space-x-3">
          <div className="relative">
            <Calendar size={16} className="absolute left-3 top-1/2 -translate-y-1/2 text-neutral-500"/>
            <select 
              value={dateRange}
              onChange={(e) => setDateRange(e.target.value)}
              className="bg-neutral-950 border border-neutral-700 text-white text-sm rounded-lg pl-9 pr-8 py-2 focus:border-amber-500 outline-none appearance-none"
            >
              <option>Last 7 Days</option>
              <option>This Month</option>
              <option>Last Quarter</option>
              <option>Year to Date</option>
            </select>
            <ChevronDown size={14} className="absolute right-3 top-1/2 -translate-y-1/2 text-neutral-500 pointer-events-none"/>
          </div>
          <button 
            onClick={handleDownloadStatement}
            className="flex items-center px-4 py-2 bg-neutral-800 hover:bg-neutral-700 text-white rounded-lg text-sm font-medium border border-neutral-700 transition-colors"
          >
            <Download size={16} className="mr-2"/> Download Statement
          </button>
        </div>
      </div>

      {/* 2. Key Metrics for Selected Period */}
      <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div className="bg-neutral-900 p-5 rounded-xl border border-neutral-800">
          <p className="text-xs text-neutral-500 uppercase font-bold">Period Revenue</p>
          <div className="flex items-end justify-between mt-2">
            <span className="text-2xl font-bold text-white">$4,250.00</span>
            <span className="text-xs text-emerald-400 flex items-center bg-emerald-500/10 px-2 py-1 rounded">+12% vs last</span>
          </div>
        </div>
        <div className="bg-neutral-900 p-5 rounded-xl border border-neutral-800">
          <p className="text-xs text-neutral-500 uppercase font-bold">New Clients</p>
          <div className="flex items-end justify-between mt-2">
            <span className="text-2xl font-bold text-white">18</span>
            <span className="text-xs text-neutral-400 flex items-center bg-neutral-800 px-2 py-1 rounded">0% vs last</span>
          </div>
        </div>
        <div className="bg-neutral-900 p-5 rounded-xl border border-neutral-800">
          <p className="text-xs text-neutral-500 uppercase font-bold">Total Volume</p>
          <div className="flex items-end justify-between mt-2">
            <span className="text-2xl font-bold text-amber-500">840 Lots</span>
            <span className="text-xs text-emerald-400 flex items-center bg-emerald-500/10 px-2 py-1 rounded">+5% vs last</span>
          </div>
        </div>
      </div>

      {/* 3. Detailed Charts Row */}
      <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
        
        {/* Volume Breakdown (Asset Class) */}
        <div className="bg-neutral-900 p-6 rounded-xl border border-neutral-800">
          <h3 className="font-bold text-white mb-6">Volume by Asset Class</h3>
          <div className="space-y-4">
            {[
              { label: 'XAUUSD (Gold)', pct: 65, color: 'bg-amber-500' },
              { label: 'EURUSD', pct: 20, color: 'bg-blue-500' },
              { label: 'GBPUSD', pct: 10, color: 'bg-indigo-500' },
              { label: 'Indices', pct: 5, color: 'bg-neutral-600' }
            ].map((item, i) => (
              <div key={i}>
                <div className="flex justify-between text-sm mb-1">
                  <span className="text-neutral-300">{item.label}</span>
                  <span className="text-white font-bold">{item.pct}%</span>
                </div>
                <div className="w-full bg-neutral-800 rounded-full h-2">
                  <div className={`h-2 rounded-full ${item.color}`} style={{ width: `${item.pct}%` }}></div>
                </div>
              </div>
            ))}
          </div>
        </div>

        {/* Net Flow Analysis */}
        <div className="bg-neutral-900 p-6 rounded-xl border border-neutral-800 flex flex-col">
          <h3 className="font-bold text-white mb-6">Net Funding Flow</h3>
          <div className="flex-1 flex items-end justify-around space-x-4 h-48 px-2 border-b border-neutral-800 relative">
             <div className="absolute top-1/2 w-full border-t border-dashed border-neutral-800"></div>
             {[
               { month: 'Jan', dep: 80, with: 20 },
               { month: 'Feb', dep: 60, with: 30 },
               { month: 'Mar', dep: 90, with: 10 },
               { month: 'Apr', dep: 40, with: 50 },
             ].map((m, i) => (
               <div key={i} className="flex flex-col items-center space-y-1 h-full justify-end w-full">
                 <div className="w-full flex space-x-1 items-end h-full justify-center">
                    <div className="w-3 bg-emerald-500 rounded-t-sm" style={{ height: `${m.dep}%` }} title="Deposits"></div>
                    <div className="w-3 bg-red-500 rounded-t-sm" style={{ height: `${m.with}%` }} title="Withdrawals"></div>
                 </div>
                 <span className="text-xs text-neutral-500">{m.month}</span>
               </div>
             ))}
          </div>
          <div className="flex justify-center gap-6 mt-4">
            <div className="flex items-center text-xs text-neutral-400"><div className="w-2 h-2 bg-emerald-500 rounded-full mr-2"></div> Deposits</div>
            <div className="flex items-center text-xs text-neutral-400"><div className="w-2 h-2 bg-red-500 rounded-full mr-2"></div> Withdrawals</div>
          </div>
        </div>
      </div>

      {/* 4. Detailed Statement Table */}
      <div className="bg-neutral-900 rounded-xl shadow-sm border border-neutral-800 overflow-hidden">
        <div className="p-4 border-b border-neutral-800 font-bold text-white bg-neutral-800/20">Daily Breakdown ({dateRange})</div>
        <div className="overflow-x-auto">
          <table className="w-full text-left text-sm">
            <thead className="bg-neutral-800/50 text-neutral-400 font-semibold">
              <tr>
                <th className="p-3">Date</th>
                <th className="p-3 text-right">Deposits</th>
                <th className="p-3 text-right">Withdrawals</th>
                <th className="p-3 text-right">Volume (Lots)</th>
                <th className="p-3 text-right">Commission</th>
              </tr>
            </thead>
            <tbody className="divide-y divide-neutral-800">
              {[
                { date: '2024-03-15', dep: 5000, wit: 0, vol: 45.2, comm: 203.40 },
                { date: '2024-03-14', dep: 1200, wit: 500, vol: 32.1, comm: 144.45 },
                { date: '2024-03-13', dep: 0, wit: 0, vol: 12.5, comm: 56.25 },
                { date: '2024-03-12', dep: 10000, wit: 0, vol: 8.0, comm: 36.00 },
              ].map((row, i) => (
                <tr key={i} className="hover:bg-neutral-800/30">
                  <td className="p-3 text-neutral-300">{row.date}</td>
                  <td className="p-3 text-right text-emerald-400">+${row.dep.toLocaleString()}</td>
                  <td className="p-3 text-right text-red-400">-${row.wit.toLocaleString()}</td>
                  <td className="p-3 text-right text-white">{row.vol}</td>
                  <td className="p-3 text-right font-bold text-amber-500">${row.comm.toFixed(2)}</td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  );
};

// D. PAYOUTS VIEW (Revised)
const PayoutsView = () => {
  const [showWithdraw, setShowWithdraw] = useState(false);
  
  const currentMonthData = { tier1: { fxLots: 120, metalLots: 30 }, tier2: { fxLots: 80, metalLots: 15 }, tier3: { fxLots: 200, metalLots: 50 }, socialProfit: 45000 };
  const calcBase = (tierData, rates) => (tierData.fxLots * rates.fx) + (tierData.metalLots * rates.metals);
  const t1Earnings = calcBase(currentMonthData.tier1, COMMISSION_RATES.tier1);
  const t2Earnings = calcBase(currentMonthData.tier2, COMMISSION_RATES.tier2);
  const t3Earnings = calcBase(currentMonthData.tier3, COMMISSION_RATES.tier3);
  const socialBonus = currentMonthData.socialProfit * 0.05;
  const totalBaseCommission = t1Earnings + t2Earnings + t3Earnings + socialBonus;
  const bonusTier = PERFORMANCE_BONUS_TIERS.find(tier => totalBaseCommission >= tier.threshold) || PERFORMANCE_BONUS_TIERS[PERFORMANCE_BONUS_TIERS.length - 1];
  const bonusAmount = totalBaseCommission * bonusTier.rate;
  const totalEarnings = totalBaseCommission + bonusAmount;

  const handleWithdrawSubmit = async (amount, method) => {
    try {
        await submitWithdrawalRequest(amount, method);
        alert("Withdrawal Requested Successfully!");
        setShowWithdraw(false);
    } catch (e) {
        alert("Error requesting withdrawal: " + e.message);
    }
  };

  return (
    <div className="space-y-6 animate-fadeIn relative">
      {showWithdraw && (
        <WithdrawalModal 
            onClose={() => setShowWithdraw(false)} 
            onSubmit={handleWithdrawSubmit} 
            available={450.00}
        />
      )}

      <div className="bg-neutral-900 border border-neutral-800 rounded-xl p-8 text-white flex flex-col md:flex-row justify-between items-center shadow-lg shadow-black/20">
        <div><h2 className="text-2xl font-bold">Current Month Earnings</h2><p className="text-neutral-400 mt-1">Estimations based on live trading volume.</p></div>
        <div className="mt-4 md:mt-0 text-right"><div className="text-sm text-neutral-500 uppercase tracking-wide font-semibold">Total Estimated Payout</div><div className="text-4xl font-bold text-amber-500 mt-1 shadow-amber-500/10 drop-shadow-lg">${totalEarnings.toLocaleString(undefined, {minimumFractionDigits: 2})}</div></div>
      </div>
      <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div className="lg:col-span-2 space-y-6">
          <div className="bg-neutral-900 rounded-xl shadow-sm border border-neutral-800 p-6">
            <h3 className="font-bold text-white mb-4 flex items-center"><Calculator size={20} className="mr-2 text-amber-500"/> Rebate Breakdown</h3>
            <div className="overflow-hidden rounded-lg border border-neutral-800">
              <table className="w-full text-left text-sm">
                <thead className="bg-neutral-800/50 text-neutral-400 font-semibold border-b border-neutral-800"><tr><th className="p-3">Source</th><th className="p-3 text-right">Volume</th><th className="p-3 text-right">Earnings</th></tr></thead>
                <tbody className="divide-y divide-neutral-800">
                  <tr><td className="p-3 font-medium text-neutral-200">Tier 1 (Direct)</td><td className="p-3 text-right text-neutral-400">{currentMonthData.tier1.fxLots} FX / {currentMonthData.tier1.metalLots} Metal</td><td className="p-3 text-right font-bold text-neutral-200">${t1Earnings.toFixed(2)}</td></tr>
                  <tr><td className="p-3 font-medium text-neutral-200">Tier 2</td><td className="p-3 text-right text-neutral-400">{currentMonthData.tier2.fxLots} FX / {currentMonthData.tier2.metalLots} Metal</td><td className="p-3 text-right font-bold text-neutral-200">${t2Earnings.toFixed(2)}</td></tr>
                  <tr><td className="p-3 font-medium text-neutral-200">Tier 3</td><td className="p-3 text-right text-neutral-400">{currentMonthData.tier3.fxLots} FX / {currentMonthData.tier3.metalLots} Metal</td><td className="p-3 text-right font-bold text-neutral-200">${t3Earnings.toFixed(2)}</td></tr>
                  <tr className="bg-amber-500/5 border-t border-amber-500/10"><td className="p-3 font-medium text-amber-500">Social Bonus</td><td className="p-3 text-right text-neutral-400">${currentMonthData.socialProfit} Profit</td><td className="p-3 text-right font-bold text-amber-500">+${socialBonus.toFixed(2)}</td></tr>
                </tbody>
              </table>
            </div>
          </div>
          <div className="bg-neutral-900 rounded-xl shadow-sm border border-neutral-800 p-6">
             <div className="flex justify-between items-center mb-4">
                <h3 className="font-bold text-white flex items-center"><CreditCard size={20} className="mr-2 text-neutral-500"/> Withdrawal History</h3>
                <button 
                  onClick={() => setShowWithdraw(true)}
                  className="px-4 py-2 bg-amber-500 text-neutral-900 rounded-lg text-sm font-bold hover:bg-amber-400 transition-colors shadow-lg shadow-amber-500/20"
                >
                  Request Withdrawal
                </button>
             </div>
             <div className="overflow-x-auto">
               <table className="w-full text-left text-sm">
                  <thead className="bg-neutral-800/50 text-neutral-400 font-semibold border-b border-neutral-800"><tr><th className="p-3">Date</th><th className="p-3">Method</th><th className="p-3 text-right">Amount</th><th className="p-3 text-center">Status</th></tr></thead>
                  <tbody className="divide-y divide-neutral-800">{MOCK_WITHDRAWALS.map((w) => (<tr key={w.id} className="hover:bg-neutral-800/30 transition-colors"><td className="p-3 text-neutral-400 flex items-center"><Clock size={14} className="mr-2 text-neutral-600"/> {w.date}</td><td className="p-3 text-neutral-400">{w.method}</td><td className="p-3 text-right font-medium text-neutral-200">${w.amount.toLocaleString()}</td><td className="p-3 text-center"><StatusBadge status={w.status} /></td></tr>))}</tbody>
               </table>
             </div>
          </div>
        </div>
        <div className="space-y-6">
           <div className="bg-gradient-to-br from-neutral-800 to-black rounded-xl p-6 text-white shadow-lg border border-neutral-700 relative overflow-hidden">
             <div className="relative z-10">
                <h3 className="font-bold text-lg mb-1">Performance Bonus</h3>
                <p className="text-neutral-300 text-sm mb-4">Earn extra based on monthly volume.</p>
                <div className="space-y-4">
                  <div className="flex justify-between items-end"><span className="text-sm font-medium opacity-80 text-neutral-300">Current Tier</span><span className="text-xl font-bold text-white">{bonusTier.label}</span></div>
                  <div className="w-full bg-neutral-950/50 rounded-full h-2 border border-neutral-600"><div className="bg-amber-500 h-2 rounded-full" style={{ width: `${Math.min((totalBaseCommission / 5000) * 100, 100)}%` }}></div></div>
                  <div className="mt-4 pt-4 border-t border-neutral-700 flex justify-between items-center"><span className="text-sm text-neutral-300">Bonus Amount:</span><span className="font-bold text-lg text-amber-500">+${bonusAmount.toFixed(2)}</span></div>
                </div>
             </div>
           </div>
        </div>
      </div>
    </div>
  );
};

// E. NETWORK VIEW (Updated with Aggregation & Nudge)
const NetworkView = ({ userRole, ibQualificationThreshold }) => {
  const [expandedNodes, setExpandedNodes] = useState({});
  const [selectedPartner, setSelectedPartner] = useState(null);

  const toggleNode = (id) => setExpandedNodes(p => ({...p, [id]: !p[id]}));
  const handleNudge = (e, type, count) => {
    e.stopPropagation();
    alert(`System: Automatically sent '${type}' reminder emails to ${count} pending clients.`);
  };

  const NetworkRow = ({ node, level = 0 }) => {
    const isExpanded = expandedNodes[node.id];
    
    // Filter logic: Separate Qualified vs Unqualified
    const qualified = node.subPartners ? node.subPartners.filter(p => p.totalClients >= ibQualificationThreshold) : [];
    const unqualified = node.subPartners ? node.subPartners.filter(p => p.totalClients < ibQualificationThreshold) : [];
    
    // Aggregation logic for small referrers
    const aggregated = unqualified.reduce((acc, curr) => ({ clients: acc.clients + curr.totalClients, volume: acc.volume + curr.volume, revenue: acc.revenue + curr.revenue }), { clients: 0, volume: 0, revenue: 0 });
    const hasChildren = qualified.length > 0 || unqualified.length > 0;
    
    // Nudge Logic Demo
    const pendingKYC = node.id % 3 === 0 ? 4 : 0; 
    const pendingDeposit = node.id % 2 === 0 ? 2 : 0;

    return (
        <>
        <div className={`flex items-center p-4 border-b border-neutral-800 hover:bg-neutral-800/30 transition-colors ${level>0?'bg-neutral-900/50':''}`} style={{paddingLeft: `${level*24 + 16}px`}}>
            <button onClick={()=>hasChildren && toggleNode(node.id)} className={`mr-3 p-1 rounded hover:bg-neutral-700 text-neutral-400 ${!hasChildren && 'invisible'}`}>{isExpanded ? <ChevronDown size={16}/> : <ChevronRight size={16}/>}</button>
            <div className="flex-1 min-w-[200px] cursor-pointer" onClick={() => setSelectedPartner(node)}>
                <div className="flex items-center"><span className="text-white font-bold mr-2">{node.name}</span><span className="text-[10px] px-2 py-0.5 rounded border border-emerald-500/20 text-emerald-400 bg-emerald-500/10">{node.status}</span></div>
                <div className="text-xs text-neutral-500 flex items-center mt-1"><span className="mr-2">{node.type}</span><span className="flex items-center"><Map size={10} className="mr-1"/>{node.country}</span></div>
            </div>
            
            {/* Blind Nudge Buttons */}
            <div className="hidden lg:flex gap-2 mr-8">
             {pendingKYC > 0 && <button onClick={(e) => handleNudge(e, 'Complete KYC', pendingKYC)} className="flex items-center px-2 py-1 bg-neutral-800 hover:bg-neutral-700 border border-neutral-700 rounded text-[10px] text-neutral-300 transition-colors"><FileText size={10} className="mr-1 text-amber-500"/> Nudge KYC ({pendingKYC})</button>}
             {pendingDeposit > 0 && <button onClick={(e) => handleNudge(e, 'Fund Account', pendingDeposit)} className="flex items-center px-2 py-1 bg-neutral-800 hover:bg-neutral-700 border border-neutral-700 rounded text-[10px] text-neutral-300 transition-colors"><Wallet size={10} className="mr-1 text-emerald-500"/> Nudge Deposit ({pendingDeposit})</button>}
            </div>

            <div className="hidden md:flex space-x-8 text-right"><div className="w-24"><div className="text-xs text-neutral-500 uppercase">Clients</div><div className="text-white font-medium">{node.totalClients}</div></div><div className="w-24"><div className="text-xs text-neutral-500 uppercase">Volume</div><div className="text-white font-medium">{node.volume}</div></div><div className="w-24"><div className="text-xs text-neutral-500 uppercase">Revenue</div><div className="text-amber-500 font-bold">${node.revenue}</div></div></div>
        </div>
        {isExpanded && (
            <div className="border-l-2 border-neutral-800 ml-6">
                {qualified.map(child => <NetworkRow key={child.id} node={child} level={level+1} />)}
                {unqualified.length > 0 && (
                    <div className="flex items-center p-4 border-b border-neutral-800 bg-neutral-950/30 transition-colors" style={{paddingLeft: `${(level+1)*24 + 16}px`}}>
                        <div className="mr-3 w-4"></div>
                        <div className="flex-1"><div className="flex items-center"><span className="text-neutral-400 italic font-bold mr-2">Retail Referrers (Aggregated)</span><span className="text-[10px] bg-neutral-800 text-neutral-500 px-2 py-0.5 rounded border border-neutral-700">{unqualified.length} Users</span></div><div className="text-xs text-neutral-600 mt-1">Partners with &lt; {ibQualificationThreshold} clients</div></div>
                        <div className="hidden md:flex space-x-8 text-right opacity-60"><div className="w-24 font-medium text-white">{aggregated.clients}</div><div className="w-24 font-medium text-white">{aggregated.volume}</div><div className="w-24 font-bold text-white">${aggregated.revenue}</div></div>
                    </div>
                )}
            </div>
        )}
        </>
    );
  };

  return (
    <div className="space-y-6 animate-fadeIn relative">
        {selectedPartner && (
        <div className="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4">
          <div className="bg-neutral-900 border border-neutral-700 rounded-xl w-full max-w-md shadow-2xl relative p-6">
             <button onClick={() => setSelectedPartner(null)} className="absolute top-4 right-4 text-neutral-500 hover:text-white"><X size={20}/></button>
             <div className="flex items-center mb-6"><div className="w-12 h-12 rounded-full bg-neutral-800 flex items-center justify-center text-amber-500 font-bold text-lg mr-4">{selectedPartner.name.substring(0,2).toUpperCase()}</div><div><h3 className="text-xl font-bold text-white">{selectedPartner.name}</h3><p className="text-sm text-emerald-400">{selectedPartner.type}</p></div></div>
             <div className="space-y-4 mb-6"><div className="p-4 bg-neutral-950 rounded-lg border border-neutral-800"><p className="text-xs text-neutral-500 uppercase font-bold mb-2">Contact Info</p><div className="space-y-2 text-sm text-neutral-300"><div className="flex justify-between"><span>Email:</span> <span className="text-white">partner.{selectedPartner.id}@nommia.net</span></div><div className="flex justify-between"><span>Phone:</span> <span className="text-white">+44 7700 900{selectedPartner.id}</span></div></div></div></div>
             <button className="w-full py-3 bg-amber-500 hover:bg-amber-400 text-neutral-900 font-bold rounded-lg transition-colors flex items-center justify-center"><Bell size={18} className="mr-2"/> Contact Partner</button>
          </div>
        </div>
        )}
        <div className="bg-neutral-900 border border-neutral-800 p-6 rounded-xl flex justify-between items-center"><div><h2 className="text-xl font-bold text-white flex items-center"><Network size={20} className="mr-2 text-amber-500"/> Partner Network</h2><p className="text-sm text-neutral-400 mt-1">Monitor performance across your sub-IB hierarchy.</p></div><div className="text-right hidden sm:block"><div className="text-xs text-neutral-500 uppercase font-bold">Total Network Volume</div><div className="text-2xl font-bold text-white">1,560.5 <span className="text-sm text-neutral-500 font-normal">Lots</span></div></div></div>
        <div className="bg-neutral-900 border border-neutral-800 rounded-xl overflow-hidden">
            <div className="p-4 border-b border-neutral-800 bg-neutral-950/50 flex justify-between items-center text-xs font-bold text-neutral-500 uppercase tracking-wider"><div className="pl-12">Partner Name</div><div className="hidden md:flex space-x-8 pr-4"><div className="w-24 text-right">Clients</div><div className="w-24 text-right">Volume</div><div className="w-24 text-right">Revenue</div></div></div>
            <div>{MOCK_NETWORK_TREE.map(node => <NetworkRow key={node.id} node={node} />)}</div>
        </div>
    </div>
  );
};

// F. SETTINGS VIEW (Fixed: Removed Typo in Function Name)
const SettingsView = () => {
  // --- Data State ---
  const [payment, setPayment] = useState({ 
      bankName: "", accountNum: "", bic: "", 
      usdtTrc: "", usdtErc: "", usdcPol: "", usdcErc: "" 
  });
  
  const [profile, setProfile] = useState({
      name: "Alex Thompson",
      email: "alex.t@example.com",
      phone: "+44 7700 900077"
  });

  // --- Security / Modal State ---
  const [showSecurityModal, setShowSecurityModal] = useState(false);
  const [verificationType, setVerificationType] = useState('password'); // 'password' or 'save'
  const [otpStep, setOtpStep] = useState('initial'); // 'initial', 'verify'
  
  // --- Input State ---
  const [otpInput, setOtpInput] = useState('');
  const [newPassword, setNewPassword] = useState('');
  const [confirmPassword, setConfirmPassword] = useState('');

  // --- 2FA State ---
  const [isTwoFAEnabled, setIsTwoFAEnabled] = useState(false);
  const [showTwoFAModal, setShowTwoFAModal] = useState(false);
  const [twoFAStep, setTwoFAStep] = useState('scan');
  const [twoFACode, setTwoFACode] = useState('');

  // --- Handlers ---

  // 1. Trigger the Save Flow
  const initiateSave = () => {
      setVerificationType('save');
      setOtpStep('initial');
      setShowSecurityModal(true);
  };

  // 2. Trigger Password Change Flow
  const initiatePasswordChange = () => {
      setVerificationType('password');
      setOtpStep('initial');
      setShowSecurityModal(true);
  };

  // 3. Send OTP (Mock)
  const handleRequestOTP = () => { 
      alert(`Security Code sent to ${profile.email}`); 
      setOtpStep('verify'); 
  };

  // 4. Verify & Execute Action (Fixed Function Name)
  const handleFinalVerification = () => {
      if (otpInput.length < 6) return alert("Please enter a valid 6-digit OTP.");

      if (verificationType === 'password') {
          // Password Change Logic
          if (newPassword !== confirmPassword) return alert("Passwords do not match.");
          if (newPassword.length < 8) return alert("Password must be at least 8 characters.");
          alert("Success: Password updated successfully.");
      } else {
          // General Settings Save Logic
          alert("Success: Account details and payout methods saved securely.");
      }

      // Reset & Close
      setShowSecurityModal(false); 
      setOtpStep('initial'); 
      setOtpInput('');
      setNewPassword('');
      setConfirmPassword('');
  };

  // --- 2FA Handlers ---
  const handleToggle2FA = () => {
      if (isTwoFAEnabled) {
          if(window.confirm("Disable 2FA?")) setIsTwoFAEnabled(false);
      } else {
          setTwoFAStep('scan');
          setShowTwoFAModal(true);
      }
  };

  const handleVerify2FA = () => {
      if (twoFACode.length !== 6) return alert("Invalid Code");
      setIsTwoFAEnabled(true);
      setShowTwoFAModal(false);
      setTwoFACode('');
      alert("2FA Enabled Successfully");
  };

  return (
    <div className="bg-neutral-900 p-6 rounded-xl border border-neutral-800 space-y-6 animate-fadeIn relative">
        
        {/* --- SECURITY VERIFICATION MODAL (Shared for Password & Saving) --- */}
        {showSecurityModal && (
            <div className="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                <div className="bg-neutral-900 border border-neutral-700 rounded-xl w-full max-w-md shadow-2xl relative p-6">
                    <button onClick={() => setShowSecurityModal(false)} className="absolute top-4 right-4 text-neutral-500 hover:text-white"><X size={20}/></button>
                    
                    <h3 className="text-xl font-bold text-white mb-2 flex items-center">
                        <Shield size={20} className="mr-2 text-amber-500"/> 
                        {verificationType === 'password' ? 'Change Password' : 'Confirm Changes'}
                    </h3>
                    
                    {otpStep === 'initial' ? (
                        <div className="space-y-4">
                            <p className="text-sm text-neutral-400">
                                {verificationType === 'password' 
                                    ? "We need to verify your identity before changing your password." 
                                    : "You are updating sensitive account information. Please verify your identity."}
                                <br/><br/>Click below to send a code to: <span className="text-white font-bold">{profile.email}</span>
                            </p>
                            <button onClick={handleRequestOTP} className="w-full py-3 bg-amber-500 hover:bg-amber-400 text-neutral-900 font-bold rounded-lg">Send Verification Code</button>
                        </div>
                    ) : (
                        <div className="space-y-4 animate-fadeIn">
                            <div className="p-3 bg-neutral-950 border border-neutral-800 rounded-lg">
                                <label className="text-xs text-neutral-500 uppercase font-bold">Enter OTP</label>
                                <input 
                                    type="text" 
                                    placeholder="000000" 
                                    maxLength="6" 
                                    value={otpInput} 
                                    onChange={(e) => setOtpInput(e.target.value.replace(/[^0-9]/g, ''))} 
                                    className="w-full mt-1 bg-transparent border-b border-neutral-700 p-2 text-white text-center tracking-[0.5em] font-mono text-xl outline-none focus:border-amber-500" 
                                    autoFocus
                                />
                            </div>

                            {/* Only show Password fields if changing password */}
                            {verificationType === 'password' && (
                                <div className="space-y-3 pt-2">
                                    <input type="password" placeholder="New Password" value={newPassword} onChange={(e) => setNewPassword(e.target.value)} className="w-full bg-neutral-950 border border-neutral-700 rounded-lg p-3 text-white outline-none focus:border-amber-500" />
                                    <input type="password" placeholder="Confirm Password" value={confirmPassword} onChange={(e) => setConfirmPassword(e.target.value)} className="w-full bg-neutral-950 border border-neutral-700 rounded-lg p-3 text-white outline-none focus:border-amber-500" />
                                </div>
                            )}

                            <button onClick={handleFinalVerification} className="w-full py-3 bg-amber-500 hover:bg-amber-400 text-neutral-900 font-bold rounded-lg mt-2">
                                {verificationType === 'password' ? 'Update Password' : 'Save Changes'}
                            </button>
                        </div>
                    )}
                </div>
            </div>
        )}

        {/* --- 2FA SETUP MODAL --- */}
        {showTwoFAModal && (
            <div className="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                <div className="bg-neutral-900 border border-neutral-700 rounded-xl w-full max-w-md shadow-2xl relative p-6 text-center">
                    <button onClick={() => setShowTwoFAModal(false)} className="absolute top-4 right-4 text-neutral-500 hover:text-white"><X size={20}/></button>
                    <div className="mb-4 flex justify-center"><div className="p-3 bg-amber-500/10 rounded-full text-amber-500"><Shield size={32}/></div></div>
                    <h3 className="text-xl font-bold text-white mb-2">Set up 2FA</h3>
                    
                    {twoFAStep === 'scan' ? (
                        <div className="space-y-6">
                            <p className="text-sm text-neutral-400">Scan this QR code with your authenticator app.</p>
                            <div className="bg-white p-2 w-48 h-48 mx-auto rounded-lg">
                                <img src="https://api.qrserver.com/v1/create-qr-code/?size=170x170&data=otpauth://totp/Nommia:User?secret=JBSWY3DPEHPK3PXP&issuer=Nommia" alt="QR Code" className="w-full h-full" />
                            </div>
                            <button onClick={() => setTwoFAStep('verify')} className="w-full py-3 bg-neutral-800 hover:bg-neutral-700 text-white font-bold rounded-lg border border-neutral-700">I have scanned it</button>
                        </div>
                    ) : (
                        <div className="space-y-6 animate-fadeIn">
                            <p className="text-sm text-neutral-400">Enter the 6-digit code to verify.</p>
                            <input type="text" placeholder="000 000" maxLength="6" value={twoFACode} onChange={(e) => setTwoFACode(e.target.value.replace(/[^0-9]/g, ''))} className="w-full bg-neutral-950 border border-neutral-700 rounded-lg p-4 text-white text-center tracking-[0.5em] font-mono text-2xl outline-none focus:border-amber-500" autoFocus />
                            <button onClick={handleVerify2FA} className="w-full py-3 bg-amber-500 hover:bg-amber-400 text-neutral-900 font-bold rounded-lg">Verify & Enable</button>
                        </div>
                    )}
                </div>
            </div>
        )}

        {/* --- MAIN SETTINGS UI --- */}
        <div className="flex items-center"><Settings size={24} className="mr-3 text-amber-500"/><div><h2 className="text-xl font-bold text-white">Settings</h2><p className="text-sm text-neutral-400">Manage profile and payout preferences.</p></div></div>
        
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
            {/* Left Column: Payouts */}
            <div className="space-y-4">
                <h3 className="text-lg font-bold text-white flex items-center"><Wallet size={18} className="mr-2 text-neutral-500"/> Payout Methods</h3>
                
                <div className="p-4 bg-neutral-950 rounded-lg border border-neutral-800 space-y-3">
                    <p className="text-xs text-amber-500 font-bold uppercase mb-2">Bank Wire Details</p>
                    <div><label className="text-xs text-neutral-500 font-bold">Bank Name</label><input className="w-full bg-neutral-900 border border-neutral-700 rounded p-2 text-white mt-1 focus:border-amber-500 outline-none" value={payment.bankName} onChange={e=>setPayment({...payment, bankName:e.target.value})} placeholder="e.g. Barclays"/></div>
                    <div><label className="text-xs text-neutral-500 font-bold">Account Number / IBAN</label><input className="w-full bg-neutral-900 border border-neutral-700 rounded p-2 text-white mt-1 focus:border-amber-500 outline-none" value={payment.accountNum} onChange={e=>setPayment({...payment, accountNum:e.target.value})} placeholder="GB33 BARC..."/></div>
                    <div><label className="text-xs text-neutral-500 font-bold">BIC / SWIFT Code</label><input className="w-full bg-neutral-900 border border-neutral-700 rounded p-2 text-white mt-1 focus:border-amber-500 outline-none" value={payment.bic} onChange={e=>setPayment({...payment, bic:e.target.value})} placeholder="BARCGB22"/></div>
                </div>

                <div className="p-4 bg-neutral-950 rounded-lg border border-neutral-800 space-y-3">
                    <p className="text-xs text-emerald-500 font-bold uppercase mb-2">Crypto Wallets</p>
                    <div><label className="text-xs text-neutral-500 font-bold">USDT (TRC20)</label><input className="w-full bg-neutral-900 border border-neutral-700 rounded p-2 text-white mt-1 focus:border-amber-500 outline-none font-mono text-sm" value={payment.usdtTrc} onChange={e=>setPayment({...payment, usdtTrc:e.target.value})}/></div>
                    <div><label className="text-xs text-neutral-500 font-bold">USDT (ERC20)</label><input className="w-full bg-neutral-900 border border-neutral-700 rounded p-2 text-white mt-1 focus:border-amber-500 outline-none font-mono text-sm" value={payment.usdtErc} onChange={e=>setPayment({...payment, usdtErc:e.target.value})}/></div>
                    <div><label className="text-xs text-neutral-500 font-bold">USDC (POL)</label><input className="w-full bg-neutral-900 border border-neutral-700 rounded p-2 text-white mt-1 focus:border-amber-500 outline-none font-mono text-sm" value={payment.usdcPol} onChange={e=>setPayment({...payment, usdcPol:e.target.value})}/></div>
                    <div><label className="text-xs text-neutral-500 font-bold">USDC (ERC20)</label><input className="w-full bg-neutral-900 border border-neutral-700 rounded p-2 text-white mt-1 focus:border-amber-500 outline-none font-mono text-sm" value={payment.usdcErc} onChange={e=>setPayment({...payment, usdcErc:e.target.value})}/></div>
                </div>

                <div className="p-3 bg-red-900/10 border border-red-900/30 rounded-lg flex items-start">
                    <AlertCircle size={16} className="text-red-500 mt-0.5 mr-2 flex-shrink-0"/>
                    <p className="text-[10px] text-red-400 leading-tight"><strong>Disclaimer:</strong> Nommia cannot be held liable for funds sent to incorrect accounts provided here.</p>
                </div>
            </div>

            {/* Right Column: Profile & Security */}
            <div className="space-y-6">
                <div className="space-y-4">
                    <h3 className="text-lg font-bold text-white flex items-center"><Users size={18} className="mr-2 text-neutral-500"/> Basic Information</h3>
                    <div><label className="text-xs text-neutral-500 font-bold">Full Name</label><input className="w-full bg-neutral-950 border border-neutral-700 rounded p-2 text-white mt-1 focus:border-amber-500 outline-none" value={profile.name} onChange={e => setProfile({...profile, name: e.target.value})} /></div>
                    <div><label className="text-xs text-neutral-500 font-bold">Email Address</label><input className="w-full bg-neutral-950 border border-neutral-800 rounded p-2 text-neutral-500 mt-1 cursor-not-allowed" value={profile.email} disabled /><p className="text-[10px] text-neutral-600 mt-1">Contact support to change email.</p></div>
                    <div><label className="text-xs text-neutral-500 font-bold">Phone Number</label><input className="w-full bg-neutral-950 border border-neutral-700 rounded p-2 text-white mt-1 focus:border-amber-500 outline-none" value={profile.phone} onChange={e => setProfile({...profile, phone: e.target.value})} /></div>
                </div>

                <div className="pt-6 border-t border-neutral-800 space-y-4">
                    <h3 className="text-lg font-bold text-white flex items-center"><Shield size={18} className="mr-2 text-neutral-500"/> Security</h3>
                    
                    <button onClick={initiatePasswordChange} className="w-full py-3 border border-neutral-700 hover:bg-neutral-800 text-white rounded-lg font-medium transition-colors flex items-center justify-center">
                        <Lock size={16} className="mr-2"/> Change Password
                    </button>

                    <div className="flex items-center justify-between p-4 bg-neutral-950 border border-neutral-800 rounded-lg">
                        <div>
                            <div className="text-sm font-bold text-white flex items-center">
                                Two-Factor Authentication
                                {isTwoFAEnabled && <span className="ml-2 px-2 py-0.5 bg-emerald-500/10 text-emerald-400 text-[10px] rounded border border-emerald-500/20">Enabled</span>}
                            </div>
                            <p className="text-xs text-neutral-500 mt-1">Secure account with Authenticator app.</p>
                        </div>
                        <div onClick={handleToggle2FA} className={`w-12 h-6 rounded-full relative cursor-pointer transition-colors ${isTwoFAEnabled ? 'bg-emerald-500' : 'bg-neutral-700'}`}>
                            <div className={`absolute top-1 w-4 h-4 bg-white rounded-full transition-all ${isTwoFAEnabled ? 'left-7' : 'left-1'}`}></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        {/* Main Save Button with OTP Trigger */}
        <div className="text-right pt-4 border-t border-neutral-800">
            <button 
                onClick={initiateSave} 
                className="bg-amber-500 text-black px-6 py-2 rounded-lg font-bold hover:bg-amber-400 transform active:scale-95 transition-all"
            >
                Save Changes
            </button>
        </div>
    </div>
  );
};
// G. ADMIN USER MANAGEMENT VIEW (With Role Editing, Countries & Nudge Rules & OTP Save)
const AdminUserManagementView = ({ ibQualificationThreshold, setIbQualificationThreshold }) => {
    // Local state for user data
    const [users, setUsers] = useState(MOCK_ALL_USERS);
    const [editingUser, setEditingUser] = useState(null); 
    const [showModal, setShowModal] = useState(false);

    // Modal form states
    const [selectedRole, setSelectedRole] = useState('');
    const [selectedRegion, setSelectedRegion] = useState('');
    const [selectedSubManagers, setSelectedSubManagers] = useState([]);

    // New Nudge Rule State
    const [nudgeRules, setNudgeRules] = useState({
        cooldownHours: 24, // How often (e.g., once every 24 hours)
        maxNudgesPerClient: 5 // Max total nudges allowed
    });

    // OTP State for Admin Save
    const [showOtpModal, setShowOtpModal] = useState(false);
    const [otpStep, setOtpStep] = useState('initial'); // 'initial', 'verify'
    const [otpInput, setOtpInput] = useState('');
    const [pendingSaveAction, setPendingSaveAction] = useState(null); // 'user' or 'policy'

    // Full country list excluding US, Iran, Iraq, North Korea
    const availableCountries = [
        "Afghanistan", "Albania", "Algeria", "Andorra", "Angola", "Antigua and Barbuda", "Argentina", "Armenia", "Australia", "Austria", "Azerbaijan",
        "Bahamas", "Bahrain", "Bangladesh", "Barbados", "Belarus", "Belgium", "Belize", "Benin", "Bhutan", "Bolivia", "Bosnia and Herzegovina", "Botswana", "Brazil", "Brunei", "Bulgaria", "Burkina Faso", "Burundi",
        "Cabo Verde", "Cambodia", "Cameroon", "Canada", "Central African Republic", "Chad", "Chile", "China", "Colombia", "Comoros", "Congo (Democratic Republic)", "Congo (Republic)", "Costa Rica", "Croatia", "Cuba", "Cyprus", "Czech Republic",
        "Denmark", "Djibouti", "Dominica", "Dominican Republic",
        "East Timor", "Ecuador", "Egypt", "El Salvador", "Equatorial Guinea", "Eritrea", "Estonia", "Eswatini", "Ethiopia",
        "Fiji", "Finland", "France",
        "Gabon", "Gambia", "Georgia", "Germany", "Ghana", "Greece", "Grenada", "Guatemala", "Guinea", "Guinea-Bissau", "Guyana",
        "Haiti", "Honduras", "Hungary",
        "Iceland", "India", "Indonesia", "Ireland", "Israel", "Italy", "Ivory Coast",
        "Jamaica", "Japan", "Jordan",
        "Kazakhstan", "Kenya", "Kiribati", "Kosovo", "Kuwait", "Kyrgyzstan",
        "Laos", "Latvia", "Lebanon", "Lesotho", "Liberia", "Libya", "Liechtenstein", "Lithuania", "Luxembourg",
        "Madagascar", "Malawi", "Malaysia", "Maldives", "Mali", "Malta", "Marshall Islands", "Mauritania", "Mauritius", "Mexico", "Micronesia", "Moldova", "Monaco", "Mongolia", "Montenegro", "Morocco", "Mozambique", "Myanmar",
        "Namibia", "Nauru", "Nepal", "Netherlands", "New Zealand", "Nicaragua", "Niger", "Nigeria", "North Macedonia", "Norway",
        "Oman",
        "Pakistan", "Palau", "Panama", "Papua New Guinea", "Paraguay", "Peru", "Philippines", "Poland", "Portugal",
        "Qatar",
        "Romania", "Russia", "Rwanda",
        "Saint Kitts and Nevis", "Saint Lucia", "Saint Vincent and the Grenadines", "Samoa", "San Marino", "Sao Tome and Principe", "Saudi Arabia", "Senegal", "Serbia", "Seychelles", "Sierra Leone", "Singapore", "Slovakia", "Slovenia", "Solomon Islands", "Somalia", "South Africa", "South Korea", "South Sudan", "Spain", "Sri Lanka", "Sudan", "Suriname", "Sweden", "Switzerland", "Syria",
        "Taiwan", "Tajikistan", "Tanzania", "Thailand", "Togo", "Tonga", "Trinidad and Tobago", "Tunisia", "Turkey", "Turkmenistan", "Tuvalu",
        "Uganda", "Ukraine", "United Arab Emirates", "United Kingdom", "Uruguay", "Uzbekistan",
        "Vanuatu", "Vatican City", "Venezuela", "Vietnam",
        "Yemen",
        "Zambia", "Zimbabwe"
    ];

    // Open modal logic
    const handleEditClick = (user) => {
        setEditingUser(user);
        setSelectedRole(user.role);
        setSelectedRegion(user.region || '');
        setSelectedSubManagers([]); 
        setShowModal(true);
    };

    // Initiate Save with OTP
    const initiateSave = (type) => {
        setPendingSaveAction(type);
        setOtpStep('initial');
        setShowOtpModal(true);
    };

    const handleRequestOTP = () => {
        alert("OTP sent to admin email.");
        setOtpStep('verify');
    };

    // Finalize Save after OTP
    const handleFinalizeSave = () => {
        if (otpInput.length < 6) {
            alert("Invalid OTP");
            return;
        }

        if (pendingSaveAction === 'user') {
             setUsers(users.map(u => {
                if (u.id === editingUser.id) {
                    return { 
                        ...u, 
                        role: selectedRole, 
                        region: selectedRole === 'Regional Manager' ? 'Multi-Region' : selectedRegion,
                        managedIds: selectedSubManagers 
                    };
                }
                return u;
            }));
            setShowModal(false);
            setEditingUser(null);
            alert("User role updated successfully.");
        } else if (pendingSaveAction === 'policy') {
            alert("Policies saved successfully.");
        }

        setShowOtpModal(false);
        setOtpStep('initial');
        setOtpInput('');
        setPendingSaveAction(null);
    };


    const toggleSubManager = (id) => {
        if (selectedSubManagers.includes(id)) {
            setSelectedSubManagers(selectedSubManagers.filter(sid => sid !== id));
        } else {
            setSelectedSubManagers([...selectedSubManagers, id]);
        }
    };

    return (
        <div className="space-y-6 animate-fadeIn relative">
            
            {/* --- OTP MODAL --- */}
            {showOtpModal && (
                <div className="fixed inset-0 bg-black/80 backdrop-blur-sm z-[60] flex items-center justify-center p-4">
                    <div className="bg-neutral-900 border border-neutral-700 rounded-xl w-full max-w-md shadow-2xl relative p-6">
                        <button onClick={() => setShowOtpModal(false)} className="absolute top-4 right-4 text-neutral-500 hover:text-white"><X size={20}/></button>
                        <h3 className="text-xl font-bold text-white mb-2 flex items-center"><Shield size={20} className="mr-2 text-amber-500"/> Admin Verification</h3>
                        
                        {otpStep === 'initial' ? (
                            <div className="space-y-4">
                                <p className="text-sm text-neutral-400">Please verify your identity to confirm these changes.</p>
                                <button onClick={handleRequestOTP} className="w-full py-3 bg-amber-500 hover:bg-amber-400 text-neutral-900 font-bold rounded-lg">Send Verification Code</button>
                            </div>
                        ) : (
                            <div className="space-y-4 animate-fadeIn">
                                <input type="text" placeholder="000000" maxLength="6" value={otpInput} onChange={(e) => setOtpInput(e.target.value.replace(/[^0-9]/g, ''))} className="w-full bg-neutral-950 border border-neutral-700 rounded-lg p-3 text-white text-center tracking-[0.5em] font-mono text-xl outline-none focus:border-amber-500" autoFocus />
                                <button onClick={handleFinalizeSave} className="w-full py-3 bg-amber-500 hover:bg-amber-400 text-neutral-900 font-bold rounded-lg mt-2">Confirm</button>
                            </div>
                        )}
                    </div>
                </div>
            )}

            {/* --- EDIT USER MODAL --- */}
            {showModal && editingUser && (
                <div className="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                    <div className="bg-neutral-900 border border-neutral-700 rounded-xl w-full max-w-lg shadow-2xl relative p-6">
                        <button onClick={() => setShowModal(false)} className="absolute top-4 right-4 text-neutral-500 hover:text-white"><X size={20}/></button>
                        
                        <h3 className="text-xl font-bold text-white mb-1">Edit User Role</h3>
                        <p className="text-sm text-neutral-400 mb-6">Modifying permissions for <span className="text-white font-bold">{editingUser.name}</span></p>

                        <div className="space-y-5">
                            <div>
                                <label className="text-xs text-neutral-500 uppercase font-bold">Assign Role</label>
                                <select value={selectedRole} onChange={(e) => setSelectedRole(e.target.value)} className="w-full mt-1 bg-neutral-950 border border-neutral-700 rounded-lg p-2.5 text-white focus:border-amber-500 outline-none">
                                    <option value="IB">Standard IB</option>
                                    <option value="Country Manager">Country Manager</option>
                                    <option value="Regional Manager">Regional Manager</option>
                                    <option value="Admin">Administrator</option>
                                </select>
                            </div>

                            {selectedRole === 'Country Manager' && (
                                <div className="p-4 bg-neutral-950/50 border border-neutral-800 rounded-lg animate-fadeIn">
                                    <label className="text-xs text-amber-500 uppercase font-bold flex items-center mb-2"><Globe size={12} className="mr-1"/> Assign Territory</label>
                                    <select value={selectedRegion} onChange={(e) => setSelectedRegion(e.target.value)} className="w-full bg-neutral-900 border border-neutral-700 rounded-lg p-2.5 text-white focus:border-amber-500 outline-none">
                                        <option value="">Select a Country...</option>
                                        {availableCountries.map(c => <option key={c} value={c}>{c}</option>)}
                                    </select>
                                </div>
                            )}

                            {selectedRole === 'Regional Manager' && (
                                <div className="p-4 bg-neutral-950/50 border border-neutral-800 rounded-lg animate-fadeIn">
                                    <label className="text-xs text-blue-400 uppercase font-bold flex items-center mb-3"><Users size={12} className="mr-1"/> Allocate Country Managers</label>
                                    <div className="space-y-2 max-h-32 overflow-y-auto pr-2">
                                        {users.filter(u => u.role === 'Country Manager').length > 0 ? (
                                            users.filter(u => u.role === 'Country Manager').map(cm => (
                                                <div key={cm.id} className="flex items-center justify-between p-2 bg-neutral-900 border border-neutral-700 rounded hover:border-blue-500 cursor-pointer" onClick={() => toggleSubManager(cm.id)}>
                                                    <span className="text-sm text-white">{cm.name} <span className="text-neutral-500 text-xs">({cm.region})</span></span>
                                                    <div className={`w-4 h-4 rounded border flex items-center justify-center ${selectedSubManagers.includes(cm.id) ? 'bg-blue-500 border-blue-500' : 'border-neutral-600'}`}>
                                                        {selectedSubManagers.includes(cm.id) && <div className="w-2 h-2 bg-white rounded-full"></div>}
                                                    </div>
                                                </div>
                                            ))
                                        ) : (
                                            <p className="text-xs text-neutral-500 italic">No Country Managers found to allocate.</p>
                                        )}
                                    </div>
                                </div>
                            )}
                        </div>

                        <div className="mt-8 flex gap-3">
                            <button onClick={() => setShowModal(false)} className="flex-1 py-2.5 bg-neutral-800 hover:bg-neutral-700 text-white rounded-lg font-bold">Cancel</button>
                            <button onClick={() => initiateSave('user')} className="flex-1 py-2.5 bg-amber-500 hover:bg-amber-400 text-black rounded-lg font-bold">Save Changes</button>
                        </div>
                    </div>
                </div>
            )}

            {/* --- ADMIN DASHBOARD HEADER --- */}
            <div className="bg-neutral-900 p-6 rounded-xl border border-neutral-800">
                <div className="flex flex-col md:flex-row justify-between items-start md:items-center mb-6">
                    <div>
                        <h2 className="text-xl font-bold text-white flex items-center"><UserCog size={24} className="mr-3 text-red-500"/> User & Policy Management</h2>
                        <p className="text-sm text-neutral-400 mt-1">Configure global qualification and engagement rules.</p>
                    </div>
                    <button onClick={() => initiateSave('policy')} className="mt-4 md:mt-0 px-4 py-2 bg-neutral-800 hover:bg-neutral-700 border border-neutral-700 text-white rounded-lg text-sm font-bold transition-colors">
                        Save Policies
                    </button>
                </div>

                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                    {/* Qualification Rules */}
                    <div className="bg-neutral-950/50 p-4 rounded-xl border border-neutral-800">
                        <h4 className="text-xs text-neutral-500 uppercase font-bold mb-3 flex items-center"><Shield size={14} className="mr-2"/> Qualification Rules</h4>
                        <div className="flex items-center justify-between">
                            <span className="text-sm text-neutral-300">IB Threshold (Clients)</span>
                            <div className="flex items-center">
                                <input 
                                    type="number" 
                                    value={ibQualificationThreshold} 
                                    onChange={e => setIbQualificationThreshold(Number(e.target.value))} 
                                    className="bg-neutral-800 text-white border border-neutral-700 rounded w-16 text-center py-1 focus:border-red-500 outline-none font-bold"
                                />
                            </div>
                        </div>
                        <p className="text-[10px] text-neutral-500 mt-2">Partners must refer this many active clients to appear in the Network Tree.</p>
                    </div>

                    {/* Engagement / Nudge Rules (NEW) */}
                    <div className="bg-neutral-950/50 p-4 rounded-xl border border-neutral-800">
                        <h4 className="text-xs text-neutral-500 uppercase font-bold mb-3 flex items-center"><Bell size={14} className="mr-2"/> Engagement Policy (Nudges)</h4>
                        <div className="flex gap-4">
                            <div className="flex-1">
                                <label className="text-[10px] text-neutral-400 block mb-1">Cooldown (Hours)</label>
                                <input 
                                    type="number" 
                                    value={nudgeRules.cooldownHours}
                                    onChange={e => setNudgeRules({...nudgeRules, cooldownHours: Number(e.target.value)})}
                                    className="w-full bg-neutral-800 text-white border border-neutral-700 rounded py-1 px-2 focus:border-amber-500 outline-none text-sm"
                                />
                            </div>
                            <div className="flex-1">
                                <label className="text-[10px] text-neutral-400 block mb-1">Max Per Client</label>
                                <input 
                                    type="number" 
                                    value={nudgeRules.maxNudgesPerClient}
                                    onChange={e => setNudgeRules({...nudgeRules, maxNudgesPerClient: Number(e.target.value)})}
                                    className="w-full bg-neutral-800 text-white border border-neutral-700 rounded py-1 px-2 focus:border-amber-500 outline-none text-sm"
                                />
                            </div>
                        </div>
                        <p className="text-[10px] text-neutral-500 mt-2">Limits how often managers can annoy clients with "Blind Nudges".</p>
                    </div>
                </div>
            </div>

            {/* --- USER TABLE --- */}
            <div className="bg-neutral-900 rounded-xl border border-neutral-800 overflow-hidden">
                <table className="w-full text-sm text-left">
                    <thead className="bg-neutral-950 text-neutral-400 font-semibold border-b border-neutral-800">
                        <tr>
                            <th className="p-4">Name</th>
                            <th className="p-4">Email</th>
                            <th className="p-4">Current Role</th>
                            <th className="p-4">Assigned Territory</th>
                            <th className="p-4 text-center">Status</th>
                            <th className="p-4 text-right">Actions</th>
                        </tr>
                    </thead>
                    <tbody className="divide-y divide-neutral-800">
                        {users.map(u => (
                            <tr key={u.id} className="hover:bg-neutral-800/30 transition-colors">
                                <td className="p-4 text-white font-medium">{u.name}</td>
                                <td className="p-4 text-neutral-400">{u.email}</td>
                                <td className="p-4">
                                    <span className={`px-2 py-1 rounded text-xs border ${
                                        u.role === 'Admin' ? 'bg-red-900/20 text-red-400 border-red-900/50' :
                                        u.role.includes('Manager') ? 'bg-blue-900/20 text-blue-400 border-blue-900/50' :
                                        'bg-neutral-800 text-neutral-300 border-neutral-700'
                                    }`}>
                                        {u.role}
                                    </span>
                                </td>
                                <td className="p-4 text-neutral-300">
                                    {u.role === 'Regional Manager' ? (
                                        <span className="text-xs text-neutral-500 italic">{u.managedIds ? `${u.managedIds.length} CMs Managed` : 'Unassigned'}</span>
                                    ) : (
                                        u.region || <span className="text-neutral-600">-</span>
                                    )}
                                </td>
                                <td className="p-4 text-center">
                                    <span className={`text-[10px] px-2 py-0.5 rounded border ${u.qualified ? 'bg-emerald-500/10 border-emerald-500/20 text-emerald-400' : 'bg-neutral-800 border-neutral-700 text-neutral-500'}`}>
                                        {u.qualified ? 'Active' : 'Pending'}
                                    </span>
                                </td>
                                <td className="p-4 text-right">
                                    <button 
                                        onClick={() => handleEditClick(u)}
                                        className="text-xs bg-neutral-800 hover:bg-neutral-700 border border-neutral-700 text-white px-3 py-1.5 rounded transition-colors"
                                    >
                                        Edit Role
                                    </button>
                                </td>
                            </tr>
                        ))}
                    </tbody>
                </table>
            </div>
        </div>
    );
};
// --- MAIN APP COMPONENT ---
export default function App() {
  const [isAuthenticated, setIsAuthenticated] = useState(false);
  const [currentUser, setCurrentUser] = useState(null);
  
  // Dashboard State
  const [activeTab, setActiveTab] = useState('dashboard');
  const [sidebarCollapsed, setSidebarCollapsed] = useState(false);
  const [isMobileMenuOpen, setIsMobileMenuOpen] = useState(false);
  const [showAlerts, setShowAlerts] = useState(false);
  
  // API Data State
  const [clients, setClients] = useState(MOCK_CLIENTS);
  const [apiStatus, setApiStatus] = useState('disconnected');
  const [userRole, setUserRole] = useState('IB'); 
  const [ibQualificationThreshold, setIbQualificationThreshold] = useState(5); // New Admin State

  const handleLogin = (token, username) => {
    setIsAuthenticated(true);
    setCurrentUser(username);
    initAPI(token);
  };

  const handleLogout = () => {
    setIsAuthenticated(false);
    setCurrentUser(null);
    setClients(MOCK_CLIENTS);
    setApiStatus('disconnected');
  };

  const initAPI = async (token) => {
    try {
      console.log("Initializing API Connection with token...");
      
      await connectWebSocket(token);
      
      const realClients = await fetchNommiaClients();
      if (realClients.length > 0) {
        setClients(realClients);
      }
      
      setApiStatus('connected');
    } catch (error) {
      console.error("API Connection Failed:", error);
      setApiStatus('disconnected');
    }
  };

  if (!isAuthenticated) {
    return <Login onLoginSuccess={handleLogin} />;
  }

  const renderContent = () => {
    switch (activeTab) {
      case 'dashboard': return <DashboardView clients={clients} apiStatus={apiStatus} onNavigate={setActiveTab} />;
      case 'clients': return <ClientsView clients={clients} />;
      case 'marketing': return <MarketingView userRole={userRole} />;
      // Pass the threshold to NetworkView
      case 'network': return <NetworkView userRole={userRole} ibQualificationThreshold={ibQualificationThreshold} />;
      case 'payouts': return <PayoutsView />;
      case 'reports': return <ReportsView />;
      case 'settings': return <SettingsView />;
      // Add Admin View
      case 'admin': return <AdminUserManagementView ibQualificationThreshold={ibQualificationThreshold} setIbQualificationThreshold={setIbQualificationThreshold} />;
      default: return <DashboardView clients={clients} apiStatus={apiStatus} onNavigate={setActiveTab} />;
    }
  };

  return (
    <div className="min-h-screen bg-neutral-950 font-sans text-neutral-100 flex overflow-hidden">
      {isMobileMenuOpen && <div className="fixed inset-0 bg-black/80 backdrop-blur-sm z-40 lg:hidden" onClick={() => setIsMobileMenuOpen(false)}></div>}
      
      <aside className={`fixed lg:static inset-y-0 left-0 z-50 bg-neutral-900 text-white transition-all duration-300 flex flex-col border-r border-neutral-800 ${sidebarCollapsed && !isMobileMenuOpen ? 'w-20' : 'w-64'} ${isMobileMenuOpen ? 'translate-x-0' : '-translate-x-full lg:translate-x-0'}`}>
        <div className="h-16 flex items-center justify-center border-b border-neutral-800 relative">
          {!sidebarCollapsed || isMobileMenuOpen ? <div className="flex items-center justify-center w-full px-4"><img src="https://i.ibb.co/yc7GWG8v/Nommia-Gold-and-White-Logo.png" alt="Nommia Logo" className="h-14 w-auto object-contain transition-all duration-300" /></div> : <div className="w-full flex justify-center"><img src="https://i.ibb.co/yc7GWG8v/Nommia-Gold-and-White-Logo.png" alt="Nommia Logo" className="h-10 w-10 object-contain transition-all duration-300" /></div>}
          <button onClick={() => setIsMobileMenuOpen(false)} className="lg:hidden text-neutral-400 hover:text-white transition-colors absolute top-4 right-4"><X size={20} /></button>
          <button onClick={() => setSidebarCollapsed(!sidebarCollapsed)} className="hidden lg:block text-neutral-500 hover:text-white transition-colors absolute top-1/2 -translate-y-1/2 right-2 p-1">{sidebarCollapsed ? <Menu size={16}/> : <X size={16}/>}</button>
        </div>
        
        <div className="flex-1 overflow-y-auto py-6 px-3">
          <SidebarItem icon={LayoutDashboard} label="Overview" active={activeTab === 'dashboard'} onClick={() => setActiveTab('dashboard')} collapsed={sidebarCollapsed && !isMobileMenuOpen} />
          <SidebarItem icon={Users} label="Clients" active={activeTab === 'clients'} onClick={() => setActiveTab('clients')} collapsed={sidebarCollapsed && !isMobileMenuOpen} />
          <SidebarItem icon={LinkIcon} label="Marketing" active={activeTab === 'marketing'} onClick={() => setActiveTab('marketing')} collapsed={sidebarCollapsed && !isMobileMenuOpen} />
          <SidebarItem icon={Network} label="Network" active={activeTab === 'network'} onClick={() => setActiveTab('network')} collapsed={sidebarCollapsed && !isMobileMenuOpen} />
          <SidebarItem icon={PieChart} label="Reports" active={activeTab === 'reports'} onClick={() => setActiveTab('reports')} collapsed={sidebarCollapsed && !isMobileMenuOpen} />
          <SidebarItem icon={DollarSign} label="Payouts" active={activeTab === 'payouts'} onClick={() => setActiveTab('payouts')} collapsed={sidebarCollapsed && !isMobileMenuOpen} />
          
          {userRole === 'Admin' && (
             <>
               <div className="my-2 border-t border-neutral-800 mx-2"></div>
               <SidebarItem icon={UserCog} label="User Management" active={activeTab === 'admin'} onClick={() => setActiveTab('admin')} collapsed={sidebarCollapsed && !isMobileMenuOpen} />
             </>
          )}

          <div className="my-4 border-t border-neutral-800 mx-2"></div>
          
           <div className={`px-3 py-2 ${sidebarCollapsed ? 'hidden' : 'block'}`}>
               <div className="bg-neutral-800/50 rounded-lg p-2 border border-neutral-700 mb-4">
                 <p className="text-xs text-neutral-500 uppercase font-bold mb-2 text-center">Demo View As:</p>
                 <div className="flex gap-1 justify-center flex-wrap">
                   <button onClick={() => setUserRole('IB')} className={`px-2 py-1 text-[10px] rounded mb-1 ${userRole === 'IB' ? 'bg-amber-500 text-black font-bold' : 'bg-neutral-700 text-neutral-400'}`}>IB</button>
                   <button onClick={() => setUserRole('CountryManager')} className={`px-2 py-1 text-[10px] rounded mb-1 ${userRole === 'CountryManager' ? 'bg-amber-500 text-black font-bold' : 'bg-neutral-700 text-neutral-400'}`}>CM</button>
                   <button onClick={() => setUserRole('RegionalManager')} className={`px-2 py-1 text-[10px] rounded mb-1 ${userRole === 'RegionalManager' ? 'bg-amber-500 text-black font-bold' : 'bg-neutral-700 text-neutral-400'}`}>RM</button>
                   <button onClick={() => {setUserRole('Admin'); setActiveTab('admin');}} className={`px-2 py-1 text-[10px] rounded mb-1 ${userRole === 'Admin' ? 'bg-red-500 text-white font-bold' : 'bg-neutral-700 text-neutral-400'}`}>Admin</button>
                 </div>
               </div>
           </div>
        </div>
        
        <div className="p-4 border-t border-neutral-800">
           <SidebarItem icon={Settings} label="Settings" active={activeTab === 'settings'} onClick={() => setActiveTab('settings')} collapsed={sidebarCollapsed && !isMobileMenuOpen} />
          {!sidebarCollapsed && (
            <div className="mt-4 flex items-center p-3 bg-neutral-800 rounded-xl border border-neutral-700">
              <div className="w-10 h-10 rounded-full bg-gradient-to-tr from-amber-500 to-amber-700 flex items-center justify-center text-sm font-bold shadow-lg text-white">
                 {currentUser ? currentUser.substring(0, 2).toUpperCase() : 'IB'}
              </div>
              <div className="ml-3 overflow-hidden">
                <p className="text-sm font-medium truncate text-white">{currentUser || 'Partner'}</p>
                <p className="text-xs text-neutral-400 truncate">ID: 88321</p>
              </div>
            </div>
          )}
        </div>
      </aside>
      
      <main className="flex-1 flex flex-col h-screen overflow-hidden relative">
        <header className="h-16 bg-neutral-900 border-b border-neutral-800 flex items-center justify-between px-4 lg:px-8 shadow-sm relative">
          <div className="flex items-center">
            <button onClick={() => setIsMobileMenuOpen(true)} className="lg:hidden mr-4 text-neutral-400 hover:text-white transition-colors"><Menu size={24} /></button>
            <button onClick={() => setSidebarCollapsed(!sidebarCollapsed)} className="hidden lg:block text-neutral-400 hover:text-white transition-colors">{sidebarCollapsed ? <Menu size={20}/> : <Menu size={20}/>}</button>
            <h1 className="ml-4 text-xl font-bold text-white capitalize hidden sm:block">{activeTab === 'admin' ? 'Admin Control Panel' : activeTab}</h1>
          </div>
          
          <div className="flex items-center space-x-4">
             {apiStatus === 'connected' && <RealTimeTicker />}

             {/* WhatsApp Support Button */}
             <a 
               href="https://wa.me/447700900000" 
               target="_blank" 
               rel="noopener noreferrer"
               className="hidden md:flex items-center px-3 py-1.5 bg-emerald-600/20 hover:bg-emerald-600/30 text-emerald-400 border border-emerald-500/30 rounded-full text-xs font-bold transition-all hover:scale-105 mr-2"
             >
               <img src="https://upload.wikimedia.org/wikipedia/commons/6/6b/WhatsApp.svg" alt="WA" className="w-4 h-4 mr-1.5" />
               Live Chat
             </a>

             <div className={`hidden md:flex items-center px-3 py-1 rounded-full text-sm font-medium border shadow-[0_0_10px_rgba(16,185,129,0.2)] ${apiStatus === 'connected' ? 'bg-emerald-500/10 text-emerald-400 border-emerald-500/20' : 'bg-amber-500/10 text-amber-400 border-amber-500/20'}`}>
                <div className={`w-2 h-2 rounded-full mr-2 ${apiStatus === 'connected' ? 'bg-emerald-500 animate-pulse' : 'bg-amber-500'}`}></div>{apiStatus === 'connected' ? 'System Operational' : 'Offline Mode'}
             </div>
             
             {/* --- SYSTEM ALERTS DROPDOWN --- */}
             <div className="relative">
                 <button 
                    onClick={() => setShowAlerts(!showAlerts)}
                    className={`relative p-2 rounded-full transition-colors ${showAlerts ? 'bg-neutral-800 text-white' : 'text-neutral-400 hover:bg-neutral-800 hover:text-white'}`}
                 >
                    <AlertCircle size={20} />
                    <span className="absolute top-1.5 right-1.5 w-2 h-2 bg-red-500 rounded-full border border-neutral-900 shadow-md animate-pulse"></span>
                 </button>

                 {showAlerts && (
                    <>
                        <div className="fixed inset-0 z-30" onClick={() => setShowAlerts(false)}></div> {/* Overlay to close on click-out */}
                        <div className="absolute right-0 mt-3 w-80 bg-neutral-900 border border-neutral-700 rounded-xl shadow-2xl z-40 overflow-hidden animate-fadeIn">
                            <div className="p-3 border-b border-neutral-800 font-bold text-white text-sm bg-neutral-950 flex justify-between items-center">
                                <span>System Alerts</span>
                                <span className="text-[10px] bg-red-500/20 text-red-400 px-1.5 py-0.5 rounded border border-red-500/30">3 New</span>
                            </div>
                            <div className="max-h-64 overflow-y-auto">
                                {MOCK_SYSTEM_ALERTS.map(alert => (
                                    <div key={alert.id} className="p-3 border-b border-neutral-800 hover:bg-neutral-800 transition-colors cursor-pointer group">
                                        <div className="flex justify-between items-start mb-1">
                                            <span className={`text-xs font-bold ${alert.type === 'critical' ? 'text-red-500' : alert.type === 'success' ? 'text-emerald-500' : 'text-amber-500'}`}>
                                                {alert.title}
                                            </span>
                                            <span className="text-[10px] text-neutral-600">{alert.time}</span>
                                        </div>
                                        <p className="text-xs text-neutral-300 group-hover:text-white transition-colors leading-snug">{alert.msg}</p>
                                    </div>
                                ))}
                            </div>
                            <div className="p-2 text-center bg-neutral-950">
                                <button className="text-[10px] text-neutral-500 hover:text-white uppercase font-bold tracking-wider">Mark all read</button>
                            </div>
                        </div>
                    </>
                 )}
             </div>
             
             <div className="h-8 w-px bg-neutral-800 mx-2"></div>
             <button onClick={handleLogout} className="flex items-center text-sm font-medium text-neutral-400 hover:text-white transition-colors"><span className="mr-2">Logout</span></button>
          </div>
        </header>
        
        <div className="flex-1 overflow-auto p-4 lg:p-8 bg-neutral-950" style={{ backgroundImage: `url("https://i.ibb.co/kV35BSfn/graphic3-b.png")`, backgroundRepeat: 'no-repeat', backgroundPosition: 'center center', backgroundSize: 'cover', backgroundAttachment: 'fixed' }}>
          <div className="max-w-7xl mx-auto">{renderContent()}</div>
        </div>
      </main>
    </div>
  );
}